<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark">
    <meta name="supported-color-schemes" content="light dark">

    <title>WinFsp Tutorial &middot; WinFsp</title>

    <link rel="stylesheet" href="../../css/primer.css" />
    <link rel="stylesheet" href="../../css/site.css" />
  </head>
  <body class="bg-white text-gray-dark">
    <div id="container" class="container-lg clearfix">

      <div id="top" class="d-block d-md-none">
        <div class="clearfix bg-gray-light border-bottom p-3">
          <img src="../../logo.png" class="float-left mr-3 auto-invert" style="height:32px;" />
          <h1 class="f2-light text-uppercase float-left">WinFsp</h1>
          <details class="dropdown details-reset details-overlay float-right">
            <summary class="btn-octicon" aria-haspopup="true">
              <img src="../../svg/three-bars.svg" class="auto-invert" />
            </summary>
            <ul class="dropdown-menu dropdown-menu-w">
              <li><a class="dropdown-item" href="../../">Main</a></li><li><a class="dropdown-item" href="../../rel">Download</a></li><li><a class="dropdown-item" href="../../apiref">API Reference</a></li><li><a class="dropdown-item" href="../../doc">Documentation</a></li><li><a class="dropdown-item" href="../../src">Source</a></li>
            </ul>
          </details>
        </div>
      </div>

      <div id="side" class="col-md-3 float-left d-none d-md-block">
        <div class="p-3" style="min-height:100vh">
          <div class="mb-3 text-center">
              <img src="../../logo.png" class="auto-invert" style="width:75%;" />
            </div>
          <h1 class="f1-light text-uppercase text-center mb-3">WinFsp</h1>
          <nav class="SideNav border"><a class="SideNav-item" href="../../" >Main</a>
              <a class="SideNav-item" href="../../rel" >Download</a>
              <a class="SideNav-item" href="../../apiref" >API Reference</a>
              <a class="SideNav-item" href="../../doc" aria-current="page">Documentation</a>
              <nav class="SideNav py-2 pl-3">
                  <a class="SideNav-subItem" href="../../doc/Frequently-Asked-Questions/" >Frequently Asked Questions</a><a class="SideNav-subItem" href="../../doc/Known-File-Systems/" >Known File Systems</a><a class="SideNav-subItem" href="../../doc/Native-API-vs-FUSE/" >Native API vs FUSE</a><a class="SideNav-subItem" href="../../doc/NTFS-Compatibility/" >NTFS Compatibility</a><a class="SideNav-subItem" href="../../doc/Queued-Events/" >Queued Events</a><a class="SideNav-subItem" href="../../doc/SSHFS-Port-Case-Study/" >SSHFS Port Case Study</a><a class="SideNav-subItem" href="../../doc/WinFsp-API-launch.h/" >WinFsp API: launch.h</a><a class="SideNav-subItem" href="../../doc/WinFsp-API-winfsp.h/" >WinFsp API: winfsp.h</a><a class="SideNav-subItem" href="../../doc/WinFsp-as-an-IPC-Mechanism/" >WinFsp as an IPC Mechanism</a><a class="SideNav-subItem" href="../../doc/WinFsp-Debugging-Setup/" >WinFsp Debugging Setup</a><a class="SideNav-subItem" href="../../doc/WinFsp-Design/" >WinFsp Design</a><a class="SideNav-subItem" href="../../doc/WinFsp-Kernel-Mode-File-Systems/" >WinFsp Kernel Mode File Systems</a><a class="SideNav-subItem" href="../../doc/WinFsp-Performance-Testing/" >WinFsp Performance Testing</a><a class="SideNav-subItem" href="../../doc/WinFsp-Service-Architecture/" >WinFsp Service Architecture</a><a class="SideNav-subItem" href="../../doc/WinFsp-Testing/" >WinFsp Testing</a><a class="SideNav-subItem" href="../../doc/WinFsp-Tutorial/" aria-current="page">WinFsp Tutorial</a>
                </nav><a class="SideNav-item" href="../../src" >Source</a>
              
          </nav>
        </div>
      </div>

      <div id="main" class="col-12 col-md-9 float-left">
        <div class="p-3 markdown-body" style="min-height:100vh">
          <h1>WinFsp Tutorial</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this tutorial we describe the process of creating a simple user mode file system using WinFsp. The file system we will create is called "passthrough", because it simply passes through the file system operations requested by the kernel to an underlying file system (usually NTFS).</p>
</div>
</div>
<div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#_prerequisites">Prerequisites</a></li>
<li><a href="#_create_the_project_skeleton">Create the project skeleton</a></li>
<li><a href="#_file_system_entryexit_points">File system entry/exit points</a>
<ul class="sectlevel2">
<li><a href="#_entry_point">Entry point</a></li>
<li><a href="#_exit_point">Exit point</a></li>
<li><a href="#_test_run">Test run</a></li>
</ul>
</li>
<li><a href="#_file_system_operations">File system operations</a>
<ul class="sectlevel2">
<li><a href="#_getsecuritybyname_open_close">GetSecurityByName / Open / Close</a></li>
<li><a href="#_readdirectory">ReadDirectory</a></li>
<li><a href="#_getvolumeinfo">GetVolumeInfo</a></li>
<li><a href="#_getfileinfo_getsecurity">GetFileInfo / GetSecurity</a></li>
<li><a href="#_read_write">Read / Write</a></li>
<li><a href="#_setbasicinfo_setfilesize_setsecurity">SetBasicInfo / SetFileSize / SetSecurity</a></li>
<li><a href="#_flush">Flush</a></li>
<li><a href="#_create">Create</a></li>
<li><a href="#_overwrite">Overwrite</a></li>
<li><a href="#_cleanup">Cleanup</a></li>
<li><a href="#_candelete">CanDelete</a></li>
<li><a href="#_rename">Rename</a></li>
</ul>
</li>
<li><a href="#_testing_the_file_system">Testing the file system</a></li>
<li><a href="#_running_the_file_system_as_a_service">Running the file system as a service</a></li>
<li><a href="#_conclusion">Conclusion</a></li>
</ul>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites">Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial assumes that you have WinFsp and Visual Studio 2015 installed. The WinFsp installer can be downloaded from the WinFsp GitHub repository: <a href="https://github.com/billziss-gh/winfsp" class="bare">https://github.com/billziss-gh/winfsp</a>. The Microsoft Visual Studio Community 2015 can be downloaded for free from Microsoft&#8217;s web site.</p>
</div>
<div class="paragraph">
<p>When installing WinFsp make sure to choose "Developer" to ensure that all necessary header and library files are included in the installation.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Installer.png" alt="WinFsp Installer">
</div>
</div>
<div class="paragraph">
<p>With those prerequisites out of the way we are now ready to start creating our first file system.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The file system that we will create is included as a sample with the WinFsp installer. Look in the <code>samples\passthrough</code> directory.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_the_project_skeleton">Create the project skeleton</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We first start by creating the Visual Studio project. Choose "Win32 Console Application" and then select our preferred settings. For this project we will select empty project, because we will add all files ourselves.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="NewProject.png" alt="Visual Studio New Project">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A user mode file system services requests from the operating system. Therefore it becomes an important system component and must service requests timely. In general it should be a console mode application, not block for user input after it has been initialized, and not expose a GUI. This also allows the user mode file system to be converted into a Windows service easily or to be controlled by the WinFsp.Launcher service (see the WinFsp Service Architecture document).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now create and add a file passthrough.c with the following contents:</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>passthrough.c</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-cp">#include</span> <span class="tok-cpf">&lt;winfsp/winfsp.h&gt;                                              </span><span class="tok-cp"></span>// <b class="conum">(1)</b>

<span class="tok-cp">#define PROGNAME                        &quot;passthrough&quot;</span>

<span class="tok-k">static</span>
<span class="tok-n">NTSTATUS</span> <span class="tok-nf">SvcStart</span><span class="tok-p">(</span><span class="tok-n">FSP_SERVICE</span> <span class="tok-o">*</span><span class="tok-n">Service</span><span class="tok-p">,</span> <span class="tok-n">ULONG</span> <span class="tok-n">argc</span><span class="tok-p">,</span> <span class="tok-n">PWSTR</span> <span class="tok-o">*</span><span class="tok-n">argv</span><span class="tok-p">)</span>        // <b class="conum">(2)</b>
<span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-n">STATUS_NOT_IMPLEMENTED</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-k">static</span>
<span class="tok-n">NTSTATUS</span> <span class="tok-nf">SvcStop</span><span class="tok-p">(</span><span class="tok-n">FSP_SERVICE</span> <span class="tok-o">*</span><span class="tok-n">Service</span><span class="tok-p">)</span>                                  // <b class="conum">(3)</b>
<span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-n">STATUS_NOT_IMPLEMENTED</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kt">int</span> <span class="tok-nf">wmain</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">argc</span><span class="tok-p">,</span> <span class="tok-kt">wchar_t</span> <span class="tok-o">**</span><span class="tok-n">argv</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-n">FspServiceRun</span><span class="tok-p">(</span><span class="tok-sa">L</span><span class="tok-s">&quot;&quot;</span> <span class="tok-n">PROGNAME</span><span class="tok-p">,</span> <span class="tok-n">SvcStart</span><span class="tok-p">,</span> <span class="tok-n">SvcStop</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>           // <b class="conum">(4)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Include WinFsp header file.</p>
</li>
<li>
<p>Service entry point.</p>
</li>
<li>
<p>Service exit point.</p>
</li>
<li>
<p>Run file system as a service.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This simple template allows a user mode file system to be run as a console application, as a Windows service, or as a "sub-service" controlled by the WinFsp launcher.</p>
</div>
<div class="paragraph">
<p>If we try to build the program, it will fail. We must set up the locations where Visual Studio can find the WinFsp headers and libraries. The following settings must be made:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>C/C++ &gt; General &gt; Additional Include Directories: <code>$(MSBuildProgramFiles32)\WinFsp\inc</code></p>
</li>
<li>
<p>Linker &gt; Input &gt; Additional Dependencies: <code>$(MSBuildProgramFiles32)\WinFsp\lib\winfsp-$(PlatformTarget).lib</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
These settings assume that WinFsp has been installed in the default location under "Program Files".
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We are now able to build this program. But if we try to run it:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="MissingDll.png" alt="Missing WinFsp DLL">
</div>
</div>
<div class="paragraph">
<p>We must make the WinFsp DLL available. There are multiple ways of doing this, but my preferred way is to delay load the DLL and then load the correct version of the DLL at run-time. This is explained below.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
WinFsp made a conscious decision not to install the WinFsp DLL in one of the Windows system directories. Applications that do not ship with the operating system should not be installing components in the system directories in this author&#8217;s opinion.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First add the WinFsp DLL as a delay loaded DLL. Open the project properties and change the following setting:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linker &gt; Input &gt; Delay Loaded Dll&#8217;s: <code>winfsp-$(PlatformTarget).dll</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then add the following lines in the beginning of <code>wmain</code>:</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>wmain excerpt</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span>    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">NT_SUCCESS</span><span class="tok-p">(</span><span class="tok-n">FspLoad</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">)))</span>
        <span class="tok-k">return</span> <span class="tok-n">ERROR_DELAY_LOAD_FAILED</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Running this now results in a console window:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="FirstRun.png" alt="First Run">
</div>
</div>
<div class="paragraph">
<p>The message is <code>The service passthrough has failed to start (Status=c0000002).</code> The status <code>c0000002</code> is <code>STATUS_NOT_IMPLEMENTED</code>, which is what we return from <code>SvcStart</code>. This means that our program has actually run and we are ready to start building our passthrough file system!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_file_system_entryexit_points">File system entry/exit points</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We now turn our attention to the file system entry/exit points. Recall that passthrough is written as a service and its entry and exit points are <code>SvcStart</code> and <code>SvcStop</code> respectively.</p>
</div>
<div class="sect2">
<h3 id="_entry_point">Entry point</h3>
<div class="paragraph">
<p>We start with the entry point <code>SvcStart</code> and first consider command line handling. We want the passthrough file system to be used as follows:</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>usage</strong></code></div>
<div class="content">
<pre>usage: passthrough OPTIONS

options:
    -d DebugFlags       [-1: enable all debug logs]
    -D DebugLogFile     [file path; use - for stderr]
    -u \Server\Share    [UNC prefix (single backslash)]
    -p Directory        [directory to expose as pass through file system]
    -m MountPoint       [X:|*|directory]</pre>
</div>
</div>
<div class="paragraph">
<p>The full code to handle these command line parameters is straight forward and is omitted for brevity. It can be found in the passthrough.c sample file that ships with the WinFsp installer. The code sets a number of variables that are used to configure each run of the passthrough file system.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>SvcStart excerpt</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span>    <span class="tok-n">PWSTR</span> <span class="tok-n">DebugLogFile</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-n">ULONG</span> <span class="tok-n">DebugFlags</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-n">PWSTR</span> <span class="tok-n">VolumePrefix</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-n">PWSTR</span> <span class="tok-n">PassThrough</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-n">PWSTR</span> <span class="tok-n">MountPoint</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The variable <code>DebugLogFile</code> is used to control the WinFsp debug logging mechanism. This mechanism can send messages to the debugger for display or log them into a file. The behavior is controlled by a call to <code>FspDebugLogSetHandle</code>: if this call is not made any debug log messages will be sent to the debugger; if this call is made debug log messages will be logged into the specified file handle.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>SvcStart excerpt</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span>    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">!=</span> <span class="tok-n">DebugLogFile</span><span class="tok-p">)</span>
    <span class="tok-p">{</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">==</span> <span class="tok-n">wcscmp</span><span class="tok-p">(</span><span class="tok-sa">L</span><span class="tok-s">&quot;-&quot;</span><span class="tok-p">,</span> <span class="tok-n">DebugLogFile</span><span class="tok-p">))</span>
            <span class="tok-n">DebugLogHandle</span> <span class="tok-o">=</span> <span class="tok-n">GetStdHandle</span><span class="tok-p">(</span><span class="tok-n">STD_ERROR_HANDLE</span><span class="tok-p">);</span>
        <span class="tok-k">else</span>
            <span class="tok-n">DebugLogHandle</span> <span class="tok-o">=</span> <span class="tok-n">CreateFileW</span><span class="tok-p">(</span>
                <span class="tok-n">DebugLogFile</span><span class="tok-p">,</span>
                <span class="tok-n">FILE_APPEND_DATA</span><span class="tok-p">,</span>
                <span class="tok-n">FILE_SHARE_READ</span> <span class="tok-o">|</span> <span class="tok-n">FILE_SHARE_WRITE</span><span class="tok-p">,</span>
                <span class="tok-mi">0</span><span class="tok-p">,</span>
                <span class="tok-n">OPEN_ALWAYS</span><span class="tok-p">,</span>
                <span class="tok-n">FILE_ATTRIBUTE_NORMAL</span><span class="tok-p">,</span>
                <span class="tok-mi">0</span><span class="tok-p">);</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">INVALID_HANDLE_VALUE</span> <span class="tok-o">==</span> <span class="tok-n">DebugLogHandle</span><span class="tok-p">)</span>
        <span class="tok-p">{</span>
            <span class="tok-n">fail</span><span class="tok-p">(</span><span class="tok-sa">L</span><span class="tok-s">&quot;cannot open debug log file&quot;</span><span class="tok-p">);</span>
            <span class="tok-k">goto</span> <span class="tok-n">usage</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>

        <span class="tok-n">FspDebugLogSetHandle</span><span class="tok-p">(</span><span class="tok-n">DebugLogHandle</span><span class="tok-p">);</span>
    <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The remaining variables are used to create and start an instance of the passthrough file system.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>SvcStart excerpt</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span>    <span class="tok-n">Result</span> <span class="tok-o">=</span> <span class="tok-n">PtfsCreate</span><span class="tok-p">(</span><span class="tok-n">PassThrough</span><span class="tok-p">,</span> <span class="tok-n">VolumePrefix</span><span class="tok-p">,</span> <span class="tok-n">MountPoint</span><span class="tok-p">,</span> <span class="tok-n">DebugFlags</span><span class="tok-p">,</span>
        <span class="tok-o">&amp;</span><span class="tok-n">Ptfs</span><span class="tok-p">);</span>                                                         // <b class="conum">(1)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">NT_SUCCESS</span><span class="tok-p">(</span><span class="tok-n">Result</span><span class="tok-p">))</span>
    <span class="tok-p">{</span>
        <span class="tok-n">fail</span><span class="tok-p">(</span><span class="tok-sa">L</span><span class="tok-s">&quot;cannot create file system&quot;</span><span class="tok-p">);</span>
        <span class="tok-k">goto</span> <span class="tok-n">exit</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>

    <span class="tok-n">Result</span> <span class="tok-o">=</span> <span class="tok-n">FspFileSystemStartDispatcher</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-o">-&gt;</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>         // <b class="conum">(2)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">NT_SUCCESS</span><span class="tok-p">(</span><span class="tok-n">Result</span><span class="tok-p">))</span>
    <span class="tok-p">{</span>
        <span class="tok-n">fail</span><span class="tok-p">(</span><span class="tok-sa">L</span><span class="tok-s">&quot;cannot start file system&quot;</span><span class="tok-p">);</span>
        <span class="tok-k">goto</span> <span class="tok-n">exit</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>

    <span class="tok-p">...</span>

    <span class="tok-n">Service</span><span class="tok-o">-&gt;</span><span class="tok-n">UserContext</span> <span class="tok-o">=</span> <span class="tok-n">Ptfs</span><span class="tok-p">;</span>                                        // <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Create the passthrough file system.</p>
</li>
<li>
<p>Start the file system dispatcher.</p>
</li>
<li>
<p>Associate the passthrough file system with the service instance.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We now consider the code for <code>PtfsCreate</code>:</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>PtfsCreate</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">typedef</span> <span class="tok-k">struct</span>
<span class="tok-p">{</span>
    <span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">;</span>
    <span class="tok-n">PWSTR</span> <span class="tok-n">Path</span><span class="tok-p">;</span>
<span class="tok-p">}</span> <span class="tok-n">PTFS</span><span class="tok-p">;</span>

<span class="tok-p">...</span>

<span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-n">PtfsCreate</span><span class="tok-p">(</span><span class="tok-n">PWSTR</span> <span class="tok-n">Path</span><span class="tok-p">,</span> <span class="tok-n">PWSTR</span> <span class="tok-n">VolumePrefix</span><span class="tok-p">,</span> <span class="tok-n">PWSTR</span> <span class="tok-n">MountPoint</span><span class="tok-p">,</span> <span class="tok-n">UINT32</span> <span class="tok-n">DebugFlags</span><span class="tok-p">,</span>
    <span class="tok-n">PTFS</span> <span class="tok-o">**</span><span class="tok-n">PPtfs</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">WCHAR</span> <span class="tok-n">FullPath</span><span class="tok-p">[</span><span class="tok-n">MAX_PATH</span><span class="tok-p">];</span>
    <span class="tok-n">ULONG</span> <span class="tok-n">Length</span><span class="tok-p">;</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span><span class="tok-p">;</span>
    <span class="tok-n">FILETIME</span> <span class="tok-n">CreationTime</span><span class="tok-p">;</span>
    <span class="tok-n">DWORD</span> <span class="tok-n">LastError</span><span class="tok-p">;</span>
    <span class="tok-n">FSP_FSCTL_VOLUME_PARAMS</span> <span class="tok-n">VolumeParams</span><span class="tok-p">;</span>
    <span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-n">Ptfs</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-n">NTSTATUS</span> <span class="tok-n">Result</span><span class="tok-p">;</span>

    <span class="tok-o">*</span><span class="tok-n">PPtfs</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>

    <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">CreateFileW</span><span class="tok-p">(</span>
        <span class="tok-n">Path</span><span class="tok-p">,</span> <span class="tok-n">FILE_READ_ATTRIBUTES</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
        <span class="tok-n">OPEN_EXISTING</span><span class="tok-p">,</span> <span class="tok-n">FILE_FLAG_BACKUP_SEMANTICS</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">INVALID_HANDLE_VALUE</span> <span class="tok-o">==</span> <span class="tok-n">Handle</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

    <span class="tok-n">Length</span> <span class="tok-o">=</span> <span class="tok-n">GetFinalPathNameByHandleW</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span>
        <span class="tok-n">FullPath</span><span class="tok-p">,</span> <span class="tok-n">FULLPATH_SIZE</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>                                // <b class="conum">(1)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">==</span> <span class="tok-n">Length</span><span class="tok-p">)</span>
    <span class="tok-p">{</span>
        <span class="tok-n">LastError</span> <span class="tok-o">=</span> <span class="tok-n">GetLastError</span><span class="tok-p">();</span>
        <span class="tok-n">CloseHandle</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">);</span>
        <span class="tok-k">return</span> <span class="tok-nf">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">LastError</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-sa">L</span><span class="tok-sc">&#39;\\&#39;</span> <span class="tok-o">==</span> <span class="tok-n">FullPath</span><span class="tok-p">[</span><span class="tok-n">Length</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">])</span>
        <span class="tok-n">FullPath</span><span class="tok-p">[</span><span class="tok-o">--</span><span class="tok-n">Length</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-sa">L</span><span class="tok-sc">&#39;\0&#39;</span><span class="tok-p">;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">GetFileTime</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">CreationTime</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">))</span>                      // <b class="conum">(2)</b>
    <span class="tok-p">{</span>
        <span class="tok-n">LastError</span> <span class="tok-o">=</span> <span class="tok-n">GetLastError</span><span class="tok-p">();</span>
        <span class="tok-n">CloseHandle</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">);</span>
        <span class="tok-k">return</span> <span class="tok-nf">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">LastError</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>

    <span class="tok-n">CloseHandle</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">);</span>

    <span class="tok-cm">/* from now on we must goto exit on failure */</span>

    <span class="tok-n">Ptfs</span> <span class="tok-o">=</span> <span class="tok-n">malloc</span><span class="tok-p">(</span><span class="tok-k">sizeof</span> <span class="tok-o">*</span><span class="tok-n">Ptfs</span><span class="tok-p">);</span>                                        // <b class="conum">(3)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">==</span> <span class="tok-n">Ptfs</span><span class="tok-p">)</span>
    <span class="tok-p">{</span>
        <span class="tok-n">Result</span> <span class="tok-o">=</span> <span class="tok-n">STATUS_INSUFFICIENT_RESOURCES</span><span class="tok-p">;</span>
        <span class="tok-k">goto</span> <span class="tok-n">exit</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-n">memset</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-o">*</span><span class="tok-n">Ptfs</span><span class="tok-p">);</span>

    <span class="tok-n">Length</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">Length</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-o">*</span> <span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">WCHAR</span><span class="tok-p">);</span>
    <span class="tok-n">Ptfs</span><span class="tok-o">-&gt;</span><span class="tok-n">Path</span> <span class="tok-o">=</span> <span class="tok-n">malloc</span><span class="tok-p">(</span><span class="tok-n">Length</span><span class="tok-p">);</span>                                        // <b class="conum">(3)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">==</span> <span class="tok-n">Ptfs</span><span class="tok-o">-&gt;</span><span class="tok-n">Path</span><span class="tok-p">)</span>
    <span class="tok-p">{</span>
        <span class="tok-n">Result</span> <span class="tok-o">=</span> <span class="tok-n">STATUS_INSUFFICIENT_RESOURCES</span><span class="tok-p">;</span>
        <span class="tok-k">goto</span> <span class="tok-n">exit</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-n">memcpy</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-o">-&gt;</span><span class="tok-n">Path</span><span class="tok-p">,</span> <span class="tok-n">FullPath</span><span class="tok-p">,</span> <span class="tok-n">Length</span><span class="tok-p">);</span>

    <span class="tok-n">memset</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">VolumeParams</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-n">VolumeParams</span><span class="tok-p">);</span>                      // <b class="conum">(4)</b>
    <span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">SectorSize</span> <span class="tok-o">=</span> <span class="tok-n">ALLOCATION_UNIT</span><span class="tok-p">;</span>
    <span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">SectorsPerAllocationUnit</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
    <span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">VolumeCreationTime</span> <span class="tok-o">=</span> <span class="tok-p">((</span><span class="tok-n">PLARGE_INTEGER</span><span class="tok-p">)</span><span class="tok-o">&amp;</span><span class="tok-n">CreationTime</span><span class="tok-p">)</span><span class="tok-o">-&gt;</span><span class="tok-n">QuadPart</span><span class="tok-p">;</span>
    <span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">VolumeSerialNumber</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">FileInfoTimeout</span> <span class="tok-o">=</span> <span class="tok-mi">1000</span><span class="tok-p">;</span>
    <span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">CaseSensitiveSearch</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">CasePreservedNames</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
    <span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">UnicodeOnDisk</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
    <span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">PersistentAcls</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
    <span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">PostCleanupWhenModifiedOnly</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>                       // <b class="conum">(4)</b>
    <span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">UmFileContextIsUserContext2</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>                       // <b class="conum">(4)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">!=</span> <span class="tok-n">VolumePrefix</span><span class="tok-p">)</span>
        <span class="tok-n">wcscpy_s</span><span class="tok-p">(</span><span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">Prefix</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">Prefix</span> <span class="tok-o">/</span> <span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">WCHAR</span><span class="tok-p">),</span> <span class="tok-n">VolumePrefix</span><span class="tok-p">);</span>
    <span class="tok-n">wcscpy_s</span><span class="tok-p">(</span><span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">FileSystemName</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">FileSystemName</span> <span class="tok-o">/</span> <span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">WCHAR</span><span class="tok-p">),</span>
        <span class="tok-sa">L</span><span class="tok-s">&quot;&quot;</span> <span class="tok-n">PROGNAME</span><span class="tok-p">);</span>

    <span class="tok-n">Result</span> <span class="tok-o">=</span> <span class="tok-n">FspFileSystemCreate</span><span class="tok-p">(</span>
        <span class="tok-n">VolumeParams</span><span class="tok-p">.</span><span class="tok-n">Prefix</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">?</span> <span class="tok-sa">L</span><span class="tok-s">&quot;&quot;</span> <span class="tok-nl">FSP_FSCTL_NET_DEVICE_NAME</span> <span class="tok-p">:</span> <span class="tok-sa">L</span><span class="tok-s">&quot;&quot;</span> <span class="tok-n">FSP_FSCTL_DISK_DEVICE_NAME</span><span class="tok-p">,</span>
        <span class="tok-o">&amp;</span><span class="tok-n">VolumeParams</span><span class="tok-p">,</span>
        <span class="tok-o">&amp;</span><span class="tok-n">PtfsInterface</span><span class="tok-p">,</span>
        <span class="tok-o">&amp;</span><span class="tok-n">Ptfs</span><span class="tok-o">-&gt;</span><span class="tok-n">FileSystem</span><span class="tok-p">);</span>                                             // <b class="conum">(5)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">NT_SUCCESS</span><span class="tok-p">(</span><span class="tok-n">Result</span><span class="tok-p">))</span>
        <span class="tok-k">goto</span> <span class="tok-n">exit</span><span class="tok-p">;</span>
    <span class="tok-n">Ptfs</span><span class="tok-o">-&gt;</span><span class="tok-n">FileSystem</span><span class="tok-o">-&gt;</span><span class="tok-n">UserContext</span> <span class="tok-o">=</span> <span class="tok-n">Ptfs</span><span class="tok-p">;</span>                               // <b class="conum">(5)</b>

    <span class="tok-n">Result</span> <span class="tok-o">=</span> <span class="tok-n">FspFileSystemSetMountPoint</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-o">-&gt;</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span> <span class="tok-n">MountPoint</span><span class="tok-p">);</span>  // <b class="conum">(6)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">NT_SUCCESS</span><span class="tok-p">(</span><span class="tok-n">Result</span><span class="tok-p">))</span>
        <span class="tok-k">goto</span> <span class="tok-n">exit</span><span class="tok-p">;</span>

    <span class="tok-n">FspFileSystemSetDebugLog</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-o">-&gt;</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span> <span class="tok-n">DebugFlags</span><span class="tok-p">);</span>             // <b class="conum">(7)</b>

    <span class="tok-n">Result</span> <span class="tok-o">=</span> <span class="tok-n">STATUS_SUCCESS</span><span class="tok-p">;</span>

<span class="tok-nl">exit</span><span class="tok-p">:</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">NT_SUCCESS</span><span class="tok-p">(</span><span class="tok-n">Result</span><span class="tok-p">))</span>
        <span class="tok-o">*</span><span class="tok-n">PPtfs</span> <span class="tok-o">=</span> <span class="tok-n">Ptfs</span><span class="tok-p">;</span>
    <span class="tok-k">else</span> <span class="tok-nf">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">!=</span> <span class="tok-n">Ptfs</span><span class="tok-p">)</span>
        <span class="tok-n">PtfsDelete</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-p">);</span>

    <span class="tok-k">return</span> <span class="tok-n">Result</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Get the full path name of the passthrough directory. This allows the file system to change directories safely (if it so chooses).</p>
</li>
<li>
<p>Get the creation time of the passthrough directory. We will use this time as the volume creation time.</p>
</li>
<li>
<p>Allocate memory for the passthrough file system main structure and for the passthrough directory path.</p>
</li>
<li>
<p>Initialize the file system <code>VolumeParams</code>. We want the file system to post Cleanup requests only when a file is modified (this avoids unnecessary Cleanup requests thus improving performance). We also want to treat the <code>FileContext</code> parameter as a "file descriptor".</p>
</li>
<li>
<p>Create the WinFsp <code>FileSystem</code> object.</p>
</li>
<li>
<p>Set the mount point. It can be a drive or directory.</p>
</li>
<li>
<p>Set debug log flags. Specify 0 to disable logging. Specify -1 to enable all logging.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_exit_point">Exit point</h3>
<div class="paragraph">
<p>We now consider the exit point <code>SvcStop</code>. The code for this is simple:</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>SvcStop excerpt</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span>    <span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-n">Ptfs</span> <span class="tok-o">=</span> <span class="tok-n">Service</span><span class="tok-o">-&gt;</span><span class="tok-n">UserContext</span><span class="tok-p">;</span>                                  // <b class="conum">(1)</b>

    <span class="tok-n">FspFileSystemStopDispatcher</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-o">-&gt;</span><span class="tok-n">FileSystem</span><span class="tok-p">);</span>                      // <b class="conum">(2)</b>
    <span class="tok-n">PtfsDelete</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-p">);</span>                                                   // <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Get the passthrough file system from the service instance.</p>
</li>
<li>
<p>Stop the file system dispatcher.</p>
</li>
<li>
<p>Delete the file system.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Finally the code for <code>PtfsDelete</code>:</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>PtfsDelete</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">VOID</span> <span class="tok-nf">PtfsDelete</span><span class="tok-p">(</span><span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-n">Ptfs</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">!=</span> <span class="tok-n">Ptfs</span><span class="tok-o">-&gt;</span><span class="tok-n">FileSystem</span><span class="tok-p">)</span>
        <span class="tok-n">FspFileSystemDelete</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-o">-&gt;</span><span class="tok-n">FileSystem</span><span class="tok-p">);</span>                          // <b class="conum">(1)</b>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">!=</span> <span class="tok-n">Ptfs</span><span class="tok-o">-&gt;</span><span class="tok-n">Path</span><span class="tok-p">)</span>
        <span class="tok-n">free</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-o">-&gt;</span><span class="tok-n">Path</span><span class="tok-p">);</span>                                               // <b class="conum">(2)</b>

    <span class="tok-n">free</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-p">);</span>                                                         // <b class="conum">(2)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Delete the WinFsp <code>FileSystem</code> object.</p>
</li>
<li>
<p>Free any remaining memory.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_test_run">Test run</h3>
<div class="paragraph">
<p>We can now run the program from Visual Studio or the command line. The program starts and waits for file system requests from the operating system (although we do not yet service any). Press Ctrl-C to stop the file system.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="EntryExit.png" alt="Entry/exit test run">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Pressing Ctrl-C orderly stops the file system (by calling <code>SvcStop</code>). It is however possible to forcibly stop a file system, e.g. by killing the process in the debugger. This is fine with WinFsp as <strong>all associated resources will be automatically cleaned up</strong>. This includes resources that WinFsp knows about such as kernel memory, volume devices, etc. It does not include resources that it has no knowledge about such as temporary files, network registrations, etc.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_file_system_operations">File system operations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We now start implementing the actual file system operations. These operations are the ones found in <code>FSP_FILE_SYSTEM_INTERFACE</code>. We first create stubs for all operations that our file system is going to support.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>File system operations stubs</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">GetVolumeInfo</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">FSP_FSCTL_VOLUME_INFO</span> <span class="tok-o">*</span><span class="tok-n">VolumeInfo</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-n">STATUS_INVALID_DEVICE_REQUEST</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">SetVolumeLabel_</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PWSTR</span> <span class="tok-n">VolumeLabel</span><span class="tok-p">,</span>
    <span class="tok-n">FSP_FSCTL_VOLUME_INFO</span> <span class="tok-o">*</span><span class="tok-n">VolumeInfo</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-n">STATUS_INVALID_DEVICE_REQUEST</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-p">...</span>

<span class="tok-k">static</span> <span class="tok-n">FSP_FILE_SYSTEM_INTERFACE</span> <span class="tok-n">PtfsInterface</span> <span class="tok-o">=</span>
<span class="tok-p">{</span>
    <span class="tok-n">GetVolumeInfo</span><span class="tok-p">,</span>
    <span class="tok-n">SetVolumeLabel_</span><span class="tok-p">,</span>
    <span class="tok-n">GetSecurityByName</span><span class="tok-p">,</span>
    <span class="tok-n">Create</span><span class="tok-p">,</span>
    <span class="tok-n">Open</span><span class="tok-p">,</span>
    <span class="tok-n">Overwrite</span><span class="tok-p">,</span>
    <span class="tok-n">Cleanup</span><span class="tok-p">,</span>
    <span class="tok-n">Close</span><span class="tok-p">,</span>
    <span class="tok-n">Read</span><span class="tok-p">,</span>
    <span class="tok-n">Write</span><span class="tok-p">,</span>
    <span class="tok-n">Flush</span><span class="tok-p">,</span>
    <span class="tok-n">GetFileInfo</span><span class="tok-p">,</span>
    <span class="tok-n">SetBasicInfo</span><span class="tok-p">,</span>
    <span class="tok-n">SetFileSize</span><span class="tok-p">,</span>
    <span class="tok-n">CanDelete</span><span class="tok-p">,</span>
    <span class="tok-n">Rename</span><span class="tok-p">,</span>
    <span class="tok-n">GetSecurity</span><span class="tok-p">,</span>
    <span class="tok-n">SetSecurity</span><span class="tok-p">,</span>
    <span class="tok-n">ReadDirectory</span><span class="tok-p">,</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_getsecuritybyname_open_close">GetSecurityByName / Open / Close</h3>
<div class="paragraph">
<p>At a minimum a file system needs to support <code>GetSecurityByName</code>, <code>Open</code> and <code>Close</code>. This allows one to use the command prompt to switch to the drive, but not much more. [Strictly speaking it is possible to not implement GetSecurityByName, but the file system will perform no access checks in that case.]</p>
</div>
<div class="paragraph">
<p><code>GetSecurityByName</code> is used by WinFsp to retrieve essential metadata about a file to be opened, such as its attributes and security descriptor.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>GetSecurityByName</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">GetSecurityByName</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PWSTR</span> <span class="tok-n">FileName</span><span class="tok-p">,</span> <span class="tok-n">PUINT32</span> <span class="tok-n">PFileAttributes</span><span class="tok-p">,</span>
    <span class="tok-n">PSECURITY_DESCRIPTOR</span> <span class="tok-n">SecurityDescriptor</span><span class="tok-p">,</span> <span class="tok-n">SIZE_T</span> <span class="tok-o">*</span><span class="tok-n">PSecurityDescriptorSize</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-n">Ptfs</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">FileSystem</span><span class="tok-o">-&gt;</span><span class="tok-n">UserContext</span><span class="tok-p">;</span>
    <span class="tok-n">WCHAR</span> <span class="tok-n">FullPath</span><span class="tok-p">[</span><span class="tok-n">FULLPATH_SIZE</span><span class="tok-p">];</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span><span class="tok-p">;</span>
    <span class="tok-n">FILE_ATTRIBUTE_TAG_INFO</span> <span class="tok-n">AttributeTagInfo</span><span class="tok-p">;</span>
    <span class="tok-n">DWORD</span> <span class="tok-n">SecurityDescriptorSizeNeeded</span><span class="tok-p">;</span>
    <span class="tok-n">NTSTATUS</span> <span class="tok-n">Result</span><span class="tok-p">;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">ConcatPath</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-p">,</span> <span class="tok-n">FileName</span><span class="tok-p">,</span> <span class="tok-n">FullPath</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">STATUS_OBJECT_NAME_INVALID</span><span class="tok-p">;</span>

    <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">CreateFileW</span><span class="tok-p">(</span><span class="tok-n">FullPath</span><span class="tok-p">,</span>
        <span class="tok-n">FILE_READ_ATTRIBUTES</span> <span class="tok-o">|</span> <span class="tok-n">READ_CONTROL</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
        <span class="tok-n">OPEN_EXISTING</span><span class="tok-p">,</span> <span class="tok-n">FILE_FLAG_BACKUP_SEMANTICS</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">INVALID_HANDLE_VALUE</span> <span class="tok-o">==</span> <span class="tok-n">Handle</span><span class="tok-p">)</span>
    <span class="tok-p">{</span>
        <span class="tok-n">Result</span> <span class="tok-o">=</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>
        <span class="tok-k">goto</span> <span class="tok-n">exit</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">!=</span> <span class="tok-n">PFileAttributes</span><span class="tok-p">)</span>
    <span class="tok-p">{</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">GetFileInformationByHandleEx</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span>
            <span class="tok-n">FileAttributeTagInfo</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">AttributeTagInfo</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-n">AttributeTagInfo</span><span class="tok-p">))</span>
        <span class="tok-p">{</span>
            <span class="tok-n">Result</span> <span class="tok-o">=</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>
            <span class="tok-k">goto</span> <span class="tok-n">exit</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>

        <span class="tok-o">*</span><span class="tok-n">PFileAttributes</span> <span class="tok-o">=</span> <span class="tok-n">AttributeTagInfo</span><span class="tok-p">.</span><span class="tok-n">FileAttributes</span><span class="tok-p">;</span>             // <b class="conum">(1)</b>
    <span class="tok-p">}</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">!=</span> <span class="tok-n">PSecurityDescriptorSize</span><span class="tok-p">)</span>
    <span class="tok-p">{</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">GetKernelObjectSecurity</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span>
            <span class="tok-n">OWNER_SECURITY_INFORMATION</span> <span class="tok-o">|</span> <span class="tok-n">GROUP_SECURITY_INFORMATION</span> <span class="tok-o">|</span> <span class="tok-n">DACL_SECURITY_INFORMATION</span><span class="tok-p">,</span>
            <span class="tok-n">SecurityDescriptor</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-n">DWORD</span><span class="tok-p">)</span><span class="tok-o">*</span><span class="tok-n">PSecurityDescriptorSize</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">SecurityDescriptorSizeNeeded</span><span class="tok-p">))</span>
        <span class="tok-p">{</span>
            <span class="tok-o">*</span><span class="tok-n">PSecurityDescriptorSize</span> <span class="tok-o">=</span> <span class="tok-n">SecurityDescriptorSizeNeeded</span><span class="tok-p">;</span>
            <span class="tok-n">Result</span> <span class="tok-o">=</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>
            <span class="tok-k">goto</span> <span class="tok-n">exit</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>

        <span class="tok-o">*</span><span class="tok-n">PSecurityDescriptorSize</span> <span class="tok-o">=</span> <span class="tok-n">SecurityDescriptorSizeNeeded</span><span class="tok-p">;</span>        // <b class="conum">(2)</b>
    <span class="tok-p">}</span>

    <span class="tok-n">Result</span> <span class="tok-o">=</span> <span class="tok-n">STATUS_SUCCESS</span><span class="tok-p">;</span>

<span class="tok-nl">exit</span><span class="tok-p">:</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">INVALID_HANDLE_VALUE</span> <span class="tok-o">!=</span> <span class="tok-n">Handle</span><span class="tok-p">)</span>
        <span class="tok-n">CloseHandle</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">);</span>

    <span class="tok-k">return</span> <span class="tok-n">Result</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Get file attributes.</p>
</li>
<li>
<p>Get file security.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The next call to implement is <code>Open</code>. <code>Open</code> is used to open existing files and should never create or overwrite files.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>Open</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">Open</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PWSTR</span> <span class="tok-n">FileName</span><span class="tok-p">,</span> <span class="tok-n">UINT32</span> <span class="tok-n">CreateOptions</span><span class="tok-p">,</span> <span class="tok-n">UINT32</span> <span class="tok-n">GrantedAccess</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-o">*</span><span class="tok-n">PFileContext</span><span class="tok-p">,</span> <span class="tok-n">FSP_FSCTL_FILE_INFO</span> <span class="tok-o">*</span><span class="tok-n">FileInfo</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-n">Ptfs</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">FileSystem</span><span class="tok-o">-&gt;</span><span class="tok-n">UserContext</span><span class="tok-p">;</span>
    <span class="tok-n">WCHAR</span> <span class="tok-n">FullPath</span><span class="tok-p">[</span><span class="tok-n">FULLPATH_SIZE</span><span class="tok-p">];</span>
    <span class="tok-n">ULONG</span> <span class="tok-n">CreateFlags</span><span class="tok-p">;</span>
    <span class="tok-n">PTFS_FILE_CONTEXT</span> <span class="tok-o">*</span><span class="tok-n">FileContext</span><span class="tok-p">;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">ConcatPath</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-p">,</span> <span class="tok-n">FileName</span><span class="tok-p">,</span> <span class="tok-n">FullPath</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">STATUS_OBJECT_NAME_INVALID</span><span class="tok-p">;</span>

    <span class="tok-n">FileContext</span> <span class="tok-o">=</span> <span class="tok-n">malloc</span><span class="tok-p">(</span><span class="tok-k">sizeof</span> <span class="tok-o">*</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>                          // <b class="conum">(1)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">==</span> <span class="tok-n">FileContext</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">STATUS_INSUFFICIENT_RESOURCES</span><span class="tok-p">;</span>
    <span class="tok-n">memset</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-o">*</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>

    <span class="tok-n">CreateFlags</span> <span class="tok-o">=</span> <span class="tok-n">FILE_FLAG_BACKUP_SEMANTICS</span><span class="tok-p">;</span>                           // <b class="conum">(2)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">CreateOptions</span> <span class="tok-o">&amp;</span> <span class="tok-n">FILE_DELETE_ON_CLOSE</span><span class="tok-p">)</span>
        <span class="tok-n">CreateFlags</span> <span class="tok-o">|=</span> <span class="tok-n">FILE_FLAG_DELETE_ON_CLOSE</span><span class="tok-p">;</span>                       // <b class="conum">(3)</b>

    <span class="tok-n">FileContext</span><span class="tok-o">-&gt;</span><span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">CreateFileW</span><span class="tok-p">(</span><span class="tok-n">FullPath</span><span class="tok-p">,</span>
        <span class="tok-n">GrantedAccess</span><span class="tok-p">,</span> <span class="tok-n">FILE_SHARE_READ</span> <span class="tok-o">|</span> <span class="tok-n">FILE_SHARE_WRITE</span> <span class="tok-o">|</span> <span class="tok-n">FILE_SHARE_DELETE</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
        <span class="tok-n">OPEN_EXISTING</span><span class="tok-p">,</span> <span class="tok-n">CreateFlags</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>                                 // <b class="conum">(4)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">INVALID_HANDLE_VALUE</span> <span class="tok-o">==</span> <span class="tok-n">FileContext</span><span class="tok-o">-&gt;</span><span class="tok-n">Handle</span><span class="tok-p">)</span>
    <span class="tok-p">{</span>
        <span class="tok-n">free</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>
    <span class="tok-p">}</span>

    <span class="tok-o">*</span><span class="tok-n">PFileContext</span> <span class="tok-o">=</span> <span class="tok-n">FileContext</span><span class="tok-p">;</span>

    <span class="tok-k">return</span> <span class="tok-n">GetFileInfoInternal</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-o">-&gt;</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-n">FileInfo</span><span class="tok-p">);</span>          // <b class="conum">(5)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Create the <code>FileContext</code> object. This is used to track an open file instance.</p>
</li>
<li>
<p>Allow opening of directories (<code>FILE_FLAG_BACKUP_SEMANTICS</code>).</p>
</li>
<li>
<p>Include the FILE_FLAG_DELETE_ON_CLOSE flag. File systems do not normally have to track this flag as WinFsp will track it and post the appropriate <code>Cleanup</code> request. Passing it to the underlying file system here allows us to simplify <code>Cleanup</code> for this simple file system.</p>
</li>
<li>
<p>Use OPEN_EXISTING to open existing files only. Allow full sharing (<code>FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE</code>) as WinFsp performs its own sharing checks.</p>
</li>
<li>
<p>Use <code>GetFileInfoInternal</code> to return information about the file (see below).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After the completion of many file system operations the kernel needs to have an accurate view of the file system metadata. [This is also the case with <code>Open</code>.] We create a helper function <code>GetFileInfoInternal</code> for this purpose.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>GetFileInfoInternal</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">GetFileInfoInternal</span><span class="tok-p">(</span><span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-n">FSP_FSCTL_FILE_INFO</span> <span class="tok-o">*</span><span class="tok-n">FileInfo</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">BY_HANDLE_FILE_INFORMATION</span> <span class="tok-n">ByHandleFileInfo</span><span class="tok-p">;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">GetFileInformationByHandle</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">ByHandleFileInfo</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

    <span class="tok-n">FileInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileAttributes</span> <span class="tok-o">=</span> <span class="tok-n">ByHandleFileInfo</span><span class="tok-p">.</span><span class="tok-n">dwFileAttributes</span><span class="tok-p">;</span>
    <span class="tok-n">FileInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">ReparseTag</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-n">FileInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileSize</span> <span class="tok-o">=</span>
        <span class="tok-p">((</span><span class="tok-n">UINT64</span><span class="tok-p">)</span><span class="tok-n">ByHandleFileInfo</span><span class="tok-p">.</span><span class="tok-n">nFileSizeHigh</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-mi">32</span><span class="tok-p">)</span> <span class="tok-o">|</span> <span class="tok-p">(</span><span class="tok-n">UINT64</span><span class="tok-p">)</span><span class="tok-n">ByHandleFileInfo</span><span class="tok-p">.</span><span class="tok-n">nFileSizeLow</span><span class="tok-p">;</span>
    <span class="tok-n">FileInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">AllocationSize</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">FileInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileSize</span> <span class="tok-o">+</span> <span class="tok-n">ALLOCATION_UNIT</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
        <span class="tok-o">/</span> <span class="tok-n">ALLOCATION_UNIT</span> <span class="tok-o">*</span> <span class="tok-n">ALLOCATION_UNIT</span><span class="tok-p">;</span>
    <span class="tok-n">FileInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">CreationTime</span> <span class="tok-o">=</span> <span class="tok-p">((</span><span class="tok-n">PLARGE_INTEGER</span><span class="tok-p">)</span><span class="tok-o">&amp;</span><span class="tok-n">ByHandleFileInfo</span><span class="tok-p">.</span><span class="tok-n">ftCreationTime</span><span class="tok-p">)</span><span class="tok-o">-&gt;</span><span class="tok-n">QuadPart</span><span class="tok-p">;</span>
    <span class="tok-n">FileInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">LastAccessTime</span> <span class="tok-o">=</span> <span class="tok-p">((</span><span class="tok-n">PLARGE_INTEGER</span><span class="tok-p">)</span><span class="tok-o">&amp;</span><span class="tok-n">ByHandleFileInfo</span><span class="tok-p">.</span><span class="tok-n">ftLastAccessTime</span><span class="tok-p">)</span><span class="tok-o">-&gt;</span><span class="tok-n">QuadPart</span><span class="tok-p">;</span>
    <span class="tok-n">FileInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">LastWriteTime</span> <span class="tok-o">=</span> <span class="tok-p">((</span><span class="tok-n">PLARGE_INTEGER</span><span class="tok-p">)</span><span class="tok-o">&amp;</span><span class="tok-n">ByHandleFileInfo</span><span class="tok-p">.</span><span class="tok-n">ftLastWriteTime</span><span class="tok-p">)</span><span class="tok-o">-&gt;</span><span class="tok-n">QuadPart</span><span class="tok-p">;</span>
    <span class="tok-n">FileInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">ChangeTime</span> <span class="tok-o">=</span> <span class="tok-n">FileInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">LastWriteTime</span><span class="tok-p">;</span>
    <span class="tok-n">FileInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">IndexNumber</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-n">FileInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">HardLinks</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>

    <span class="tok-k">return</span> <span class="tok-n">STATUS_SUCCESS</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Every <code>Open</code> (or <code>Create</code>) is always matched by <code>Close</code>. <code>Close</code> is the final call that will be received for an open file instance.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>Close</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">VOID</span> <span class="tok-nf">Close</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">FileContext0</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">PTFS_FILE_CONTEXT</span> <span class="tok-o">*</span><span class="tok-n">FileContext</span> <span class="tok-o">=</span> <span class="tok-n">FileContext0</span><span class="tok-p">;</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">HandleFromContext</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>

    <span class="tok-n">CloseHandle</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">);</span>                                                // <b class="conum">(1)</b>

    <span class="tok-n">FspFileSystemDeleteDirectoryBuffer</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">FileContext</span><span class="tok-o">-&gt;</span><span class="tok-n">DirBuffer</span><span class="tok-p">);</span>        // <b class="conum">(2)</b>
    <span class="tok-n">free</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>                                                  // <b class="conum">(3)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Close the file handle.</p>
</li>
<li>
<p>Delete the directory buffer (if there is one).</p>
</li>
<li>
<p>Free the <code>FileContext</code> object.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For completeness the definition of <code>PTFS_FILE_CONTEXT</code> is included here:</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>PTFS_FILE_CONTEXT</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-cp">#define HandleFromContext(FC)           (((PTFS_FILE_CONTEXT *)(FC))-&gt;Handle)</span>

<span class="tok-k">typedef</span> <span class="tok-k">struct</span>
<span class="tok-p">{</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span><span class="tok-p">;</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">DirBuffer</span><span class="tok-p">;</span>
<span class="tok-p">}</span> <span class="tok-n">PTFS_FILE_CONTEXT</span><span class="tok-p">;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_readdirectory">ReadDirectory</h3>
<div class="paragraph">
<p>Our simple file system can only open and close existing files. Supporting the Windows explorer is somewhat more involved. It requires implementation of <code>ReadDirectory</code>.</p>
</div>
<div class="paragraph">
<p><code>ReadDirectory</code> is conceptually simple: given a <code>Marker</code> file name within the directory fill the specified <code>Buffer</code> with directory contents. The idea here is that a directory can be viewed as a file with directory entries, the <code>Marker</code> is used to specify where in the file to start reading. Only files with names that are greater than (not equal to) the <code>Marker</code> (in the directory order determined by the file system) should be returned. If the <code>Marker</code> is <code>NULL</code> it means to start at the beginning of the directory file.</p>
</div>
<div class="paragraph">
<p>This scheme is simple and flexible in that it allows arbitrarily large directories to be read in chunks. If implemented correctly it can also cope with concurrent modifications to the directory (like file creations, deletions).</p>
</div>
<div class="paragraph">
<p>Not all file systems maintain a consistent directory order or are able to seek by file name within a directory. For these file systems a simple strategy is to buffer <strong>all</strong> directory contents when they receive a <code>NULL</code> <code>Marker</code>.</p>
</div>
<div class="paragraph">
<p>This is how we implement <code>ReadDirectory</code> for our passthrough file system.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>ReadDirectory</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">ReadDirectory</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">FileContext0</span><span class="tok-p">,</span> <span class="tok-n">PWSTR</span> <span class="tok-n">Pattern</span><span class="tok-p">,</span> <span class="tok-n">PWSTR</span> <span class="tok-n">Marker</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">Buffer</span><span class="tok-p">,</span> <span class="tok-n">ULONG</span> <span class="tok-n">BufferLength</span><span class="tok-p">,</span> <span class="tok-n">PULONG</span> <span class="tok-n">PBytesTransferred</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-n">Ptfs</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">FileSystem</span><span class="tok-o">-&gt;</span><span class="tok-n">UserContext</span><span class="tok-p">;</span>
    <span class="tok-n">PTFS_FILE_CONTEXT</span> <span class="tok-o">*</span><span class="tok-n">FileContext</span> <span class="tok-o">=</span> <span class="tok-n">FileContext0</span><span class="tok-p">;</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">HandleFromContext</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>
    <span class="tok-n">WCHAR</span> <span class="tok-n">FullPath</span><span class="tok-p">[</span><span class="tok-n">FULLPATH_SIZE</span><span class="tok-p">];</span>
    <span class="tok-n">ULONG</span> <span class="tok-n">Length</span><span class="tok-p">,</span> <span class="tok-n">PatternLength</span><span class="tok-p">;</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">FindHandle</span><span class="tok-p">;</span>
    <span class="tok-n">WIN32_FIND_DATAW</span> <span class="tok-n">FindData</span><span class="tok-p">;</span>
    <span class="tok-k">union</span>
    <span class="tok-p">{</span>
        <span class="tok-n">UINT8</span> <span class="tok-n">B</span><span class="tok-p">[</span><span class="tok-n">FIELD_OFFSET</span><span class="tok-p">(</span><span class="tok-n">FSP_FSCTL_DIR_INFO</span><span class="tok-p">,</span> <span class="tok-n">FileNameBuf</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-n">MAX_PATH</span> <span class="tok-o">*</span> <span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">WCHAR</span><span class="tok-p">)];</span>
        <span class="tok-n">FSP_FSCTL_DIR_INFO</span> <span class="tok-n">D</span><span class="tok-p">;</span>
    <span class="tok-p">}</span> <span class="tok-n">DirInfoBuf</span><span class="tok-p">;</span>
    <span class="tok-n">FSP_FSCTL_DIR_INFO</span> <span class="tok-o">*</span><span class="tok-n">DirInfo</span> <span class="tok-o">=</span> <span class="tok-o">&amp;</span><span class="tok-n">DirInfoBuf</span><span class="tok-p">.</span><span class="tok-n">D</span><span class="tok-p">;</span>
    <span class="tok-n">NTSTATUS</span> <span class="tok-n">DirBufferResult</span><span class="tok-p">;</span>

    <span class="tok-n">DirBufferResult</span> <span class="tok-o">=</span> <span class="tok-n">STATUS_SUCCESS</span><span class="tok-p">;</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">FspFileSystemAcquireDirectoryBuffer</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">FileContext</span><span class="tok-o">-&gt;</span><span class="tok-n">DirBuffer</span><span class="tok-p">,</span> <span class="tok-mi">0</span> <span class="tok-o">==</span> <span class="tok-n">Marker</span><span class="tok-p">,</span>
        <span class="tok-o">&amp;</span><span class="tok-n">DirBufferResult</span><span class="tok-p">))</span>                                              // <b class="conum">(1)</b>
    <span class="tok-p">{</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">==</span> <span class="tok-n">Pattern</span><span class="tok-p">)</span>
            <span class="tok-n">Pattern</span> <span class="tok-o">=</span> <span class="tok-sa">L</span><span class="tok-s">&quot;*&quot;</span><span class="tok-p">;</span>
        <span class="tok-n">PatternLength</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">ULONG</span><span class="tok-p">)</span><span class="tok-n">wcslen</span><span class="tok-p">(</span><span class="tok-n">Pattern</span><span class="tok-p">);</span>

        <span class="tok-n">Length</span> <span class="tok-o">=</span> <span class="tok-n">GetFinalPathNameByHandleW</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-n">FullPath</span><span class="tok-p">,</span> <span class="tok-n">FULLPATH_SIZE</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">==</span> <span class="tok-n">Length</span><span class="tok-p">)</span>
            <span class="tok-n">DirBufferResult</span> <span class="tok-o">=</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>
        <span class="tok-k">else</span> <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">Length</span> <span class="tok-o">+</span> <span class="tok-mi">1</span> <span class="tok-o">+</span> <span class="tok-n">PatternLength</span> <span class="tok-o">&gt;=</span> <span class="tok-n">FULLPATH_SIZE</span><span class="tok-p">)</span>
            <span class="tok-n">DirBufferResult</span> <span class="tok-o">=</span> <span class="tok-n">STATUS_OBJECT_NAME_INVALID</span><span class="tok-p">;</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">NT_SUCCESS</span><span class="tok-p">(</span><span class="tok-n">DirBufferResult</span><span class="tok-p">))</span>
        <span class="tok-p">{</span>
            <span class="tok-n">FspFileSystemReleaseDirectoryBuffer</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">FileContext</span><span class="tok-o">-&gt;</span><span class="tok-n">DirBuffer</span><span class="tok-p">);</span>
            <span class="tok-k">return</span> <span class="tok-n">DirBufferResult</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>

        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-sa">L</span><span class="tok-sc">&#39;\\&#39;</span> <span class="tok-o">!=</span> <span class="tok-n">FullPath</span><span class="tok-p">[</span><span class="tok-n">Length</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">])</span>
            <span class="tok-n">FullPath</span><span class="tok-p">[</span><span class="tok-n">Length</span><span class="tok-o">++</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-sa">L</span><span class="tok-sc">&#39;\\&#39;</span><span class="tok-p">;</span>
        <span class="tok-n">memcpy</span><span class="tok-p">(</span><span class="tok-n">FullPath</span> <span class="tok-o">+</span> <span class="tok-n">Length</span><span class="tok-p">,</span> <span class="tok-n">Pattern</span><span class="tok-p">,</span> <span class="tok-n">PatternLength</span> <span class="tok-o">*</span> <span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">WCHAR</span><span class="tok-p">));</span>
        <span class="tok-n">FullPath</span><span class="tok-p">[</span><span class="tok-n">Length</span> <span class="tok-o">+</span> <span class="tok-n">PatternLength</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-sa">L</span><span class="tok-sc">&#39;\0&#39;</span><span class="tok-p">;</span>

        <span class="tok-n">FindHandle</span> <span class="tok-o">=</span> <span class="tok-n">FindFirstFileW</span><span class="tok-p">(</span><span class="tok-n">FullPath</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">FindData</span><span class="tok-p">);</span>               // <b class="conum">(2)</b>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">INVALID_HANDLE_VALUE</span> <span class="tok-o">!=</span> <span class="tok-n">FindHandle</span><span class="tok-p">)</span>
        <span class="tok-p">{</span>
            <span class="tok-k">do</span>
            <span class="tok-p">{</span>
                <span class="tok-n">memset</span><span class="tok-p">(</span><span class="tok-n">DirInfo</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-o">*</span><span class="tok-n">DirInfo</span><span class="tok-p">);</span>
                <span class="tok-n">Length</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">ULONG</span><span class="tok-p">)</span><span class="tok-n">wcslen</span><span class="tok-p">(</span><span class="tok-n">FindData</span><span class="tok-p">.</span><span class="tok-n">cFileName</span><span class="tok-p">);</span>
                <span class="tok-n">DirInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">Size</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">UINT16</span><span class="tok-p">)(</span><span class="tok-n">FIELD_OFFSET</span><span class="tok-p">(</span><span class="tok-n">FSP_FSCTL_DIR_INFO</span><span class="tok-p">,</span> <span class="tok-n">FileNameBuf</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-n">Length</span> <span class="tok-o">*</span> <span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">WCHAR</span><span class="tok-p">));</span>
                <span class="tok-n">DirInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileInfo</span><span class="tok-p">.</span><span class="tok-n">FileAttributes</span> <span class="tok-o">=</span> <span class="tok-n">FindData</span><span class="tok-p">.</span><span class="tok-n">dwFileAttributes</span><span class="tok-p">;</span>
                <span class="tok-n">DirInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileInfo</span><span class="tok-p">.</span><span class="tok-n">ReparseTag</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
                <span class="tok-n">DirInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileInfo</span><span class="tok-p">.</span><span class="tok-n">FileSize</span> <span class="tok-o">=</span>
                    <span class="tok-p">((</span><span class="tok-n">UINT64</span><span class="tok-p">)</span><span class="tok-n">FindData</span><span class="tok-p">.</span><span class="tok-n">nFileSizeHigh</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-mi">32</span><span class="tok-p">)</span> <span class="tok-o">|</span> <span class="tok-p">(</span><span class="tok-n">UINT64</span><span class="tok-p">)</span><span class="tok-n">FindData</span><span class="tok-p">.</span><span class="tok-n">nFileSizeLow</span><span class="tok-p">;</span>
                <span class="tok-n">DirInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileInfo</span><span class="tok-p">.</span><span class="tok-n">AllocationSize</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">DirInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileInfo</span><span class="tok-p">.</span><span class="tok-n">FileSize</span> <span class="tok-o">+</span> <span class="tok-n">ALLOCATION_UNIT</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
                    <span class="tok-o">/</span> <span class="tok-n">ALLOCATION_UNIT</span> <span class="tok-o">*</span> <span class="tok-n">ALLOCATION_UNIT</span><span class="tok-p">;</span>
                <span class="tok-n">DirInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileInfo</span><span class="tok-p">.</span><span class="tok-n">CreationTime</span> <span class="tok-o">=</span> <span class="tok-p">((</span><span class="tok-n">PLARGE_INTEGER</span><span class="tok-p">)</span><span class="tok-o">&amp;</span><span class="tok-n">FindData</span><span class="tok-p">.</span><span class="tok-n">ftCreationTime</span><span class="tok-p">)</span><span class="tok-o">-&gt;</span><span class="tok-n">QuadPart</span><span class="tok-p">;</span>
                <span class="tok-n">DirInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileInfo</span><span class="tok-p">.</span><span class="tok-n">LastAccessTime</span> <span class="tok-o">=</span> <span class="tok-p">((</span><span class="tok-n">PLARGE_INTEGER</span><span class="tok-p">)</span><span class="tok-o">&amp;</span><span class="tok-n">FindData</span><span class="tok-p">.</span><span class="tok-n">ftLastAccessTime</span><span class="tok-p">)</span><span class="tok-o">-&gt;</span><span class="tok-n">QuadPart</span><span class="tok-p">;</span>
                <span class="tok-n">DirInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileInfo</span><span class="tok-p">.</span><span class="tok-n">LastWriteTime</span> <span class="tok-o">=</span> <span class="tok-p">((</span><span class="tok-n">PLARGE_INTEGER</span><span class="tok-p">)</span><span class="tok-o">&amp;</span><span class="tok-n">FindData</span><span class="tok-p">.</span><span class="tok-n">ftLastWriteTime</span><span class="tok-p">)</span><span class="tok-o">-&gt;</span><span class="tok-n">QuadPart</span><span class="tok-p">;</span>
                <span class="tok-n">DirInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileInfo</span><span class="tok-p">.</span><span class="tok-n">ChangeTime</span> <span class="tok-o">=</span> <span class="tok-n">DirInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileInfo</span><span class="tok-p">.</span><span class="tok-n">LastWriteTime</span><span class="tok-p">;</span>
                <span class="tok-n">DirInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileInfo</span><span class="tok-p">.</span><span class="tok-n">IndexNumber</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
                <span class="tok-n">DirInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileInfo</span><span class="tok-p">.</span><span class="tok-n">HardLinks</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
                <span class="tok-n">memcpy</span><span class="tok-p">(</span><span class="tok-n">DirInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FileNameBuf</span><span class="tok-p">,</span> <span class="tok-n">FindData</span><span class="tok-p">.</span><span class="tok-n">cFileName</span><span class="tok-p">,</span> <span class="tok-n">Length</span> <span class="tok-o">*</span> <span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">WCHAR</span><span class="tok-p">));</span>

                <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">FspFileSystemFillDirectoryBuffer</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">FileContext</span><span class="tok-o">-&gt;</span><span class="tok-n">DirBuffer</span><span class="tok-p">,</span> <span class="tok-n">DirInfo</span><span class="tok-p">,</span>
                    <span class="tok-o">&amp;</span><span class="tok-n">DirBufferResult</span><span class="tok-p">))</span>                                  // <b class="conum">(2)</b>
                    <span class="tok-k">break</span><span class="tok-p">;</span>
            <span class="tok-p">}</span> <span class="tok-k">while</span> <span class="tok-p">(</span><span class="tok-n">FindNextFileW</span><span class="tok-p">(</span><span class="tok-n">FindHandle</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">FindData</span><span class="tok-p">));</span>             // <b class="conum">(2)</b>

            <span class="tok-n">FindClose</span><span class="tok-p">(</span><span class="tok-n">FindHandle</span><span class="tok-p">);</span>
        <span class="tok-p">}</span>

        <span class="tok-n">FspFileSystemReleaseDirectoryBuffer</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">FileContext</span><span class="tok-o">-&gt;</span><span class="tok-n">DirBuffer</span><span class="tok-p">);</span>   // <b class="conum">(3)</b>
    <span class="tok-p">}</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">NT_SUCCESS</span><span class="tok-p">(</span><span class="tok-n">DirBufferResult</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">DirBufferResult</span><span class="tok-p">;</span>

    <span class="tok-n">FspFileSystemReadDirectoryBuffer</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">FileContext</span><span class="tok-o">-&gt;</span><span class="tok-n">DirBuffer</span><span class="tok-p">,</span>
        <span class="tok-n">Marker</span><span class="tok-p">,</span> <span class="tok-n">Buffer</span><span class="tok-p">,</span> <span class="tok-n">BufferLength</span><span class="tok-p">,</span> <span class="tok-n">PBytesTransferred</span><span class="tok-p">);</span>               // <b class="conum">(4)</b>

    <span class="tok-k">return</span> <span class="tok-n">STATUS_SUCCESS</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Acquire a directory buffer if there is not one or if <code>Marker == 0</code>.</p>
</li>
<li>
<p>Iterate over all directory entries and buffer them.</p>
</li>
<li>
<p>Release the directory buffer.</p>
</li>
<li>
<p>Copy the buffered directory contents into the specified <code>Buffer</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_getvolumeinfo">GetVolumeInfo</h3>
<div class="paragraph">
<p>The Windows explorer will often query a volume (file system) for information about it. Implementation of <code>GetVolumeInfo</code> allows us to return information about the total and free space in the file system and its volume label.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>GetVolumeInfo</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">GetVolumeInfo</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">FSP_FSCTL_VOLUME_INFO</span> <span class="tok-o">*</span><span class="tok-n">VolumeInfo</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-n">Ptfs</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">FileSystem</span><span class="tok-o">-&gt;</span><span class="tok-n">UserContext</span><span class="tok-p">;</span>
    <span class="tok-n">WCHAR</span> <span class="tok-n">Root</span><span class="tok-p">[</span><span class="tok-n">MAX_PATH</span><span class="tok-p">];</span>
    <span class="tok-n">ULARGE_INTEGER</span> <span class="tok-n">TotalSize</span><span class="tok-p">,</span> <span class="tok-n">FreeSize</span><span class="tok-p">;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">GetVolumePathName</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-o">-&gt;</span><span class="tok-n">Path</span><span class="tok-p">,</span> <span class="tok-n">Root</span><span class="tok-p">,</span> <span class="tok-n">MAX_PATH</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">GetDiskFreeSpaceEx</span><span class="tok-p">(</span><span class="tok-n">Root</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">TotalSize</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">FreeSize</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

    <span class="tok-n">VolumeInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">TotalSize</span> <span class="tok-o">=</span> <span class="tok-n">TotalSize</span><span class="tok-p">.</span><span class="tok-n">QuadPart</span><span class="tok-p">;</span>                         // <b class="conum">(1)</b>
    <span class="tok-n">VolumeInfo</span><span class="tok-o">-&gt;</span><span class="tok-n">FreeSize</span> <span class="tok-o">=</span> <span class="tok-n">FreeSize</span><span class="tok-p">.</span><span class="tok-n">QuadPart</span><span class="tok-p">;</span>                           // <b class="conum">(2)</b>
                                                                        // <b class="conum">(3)</b>
    <span class="tok-k">return</span> <span class="tok-n">STATUS_SUCCESS</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Total size in bytes.</p>
</li>
<li>
<p>Free size in bytes.</p>
</li>
<li>
<p>We do not support volume labels so we simply return the default (blank) volume label.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_getfileinfo_getsecurity">GetFileInfo / GetSecurity</h3>
<div class="paragraph">
<p>If we right click on a file and choose "Properties" on the Windows explorer, it will interrogate the file system for the file metadata. This metadata includes file information such as file size, attributes, times, etc. and security information such as ACL&#8217;s.</p>
</div>
<div class="paragraph">
<p>The <code>GetFileInfo</code> operation allows the kernel to query/refresh its view of the file metadata.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>GetFileInfo</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">GetFileInfo</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">FileContext</span><span class="tok-p">,</span>
    <span class="tok-n">FSP_FSCTL_FILE_INFO</span> <span class="tok-o">*</span><span class="tok-n">FileInfo</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">HandleFromContext</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>

    <span class="tok-k">return</span> <span class="tok-n">GetFileInfoInternal</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-n">FileInfo</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>GetSecurity</code> operation is used to return a file&#8217;s security descriptor. [Please note that file systems that do not support ACL&#8217;s need not implement this function.]</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>GetSecurity</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">GetSecurity</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">FileContext</span><span class="tok-p">,</span>
    <span class="tok-n">PSECURITY_DESCRIPTOR</span> <span class="tok-n">SecurityDescriptor</span><span class="tok-p">,</span> <span class="tok-n">SIZE_T</span> <span class="tok-o">*</span><span class="tok-n">PSecurityDescriptorSize</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">HandleFromContext</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>
    <span class="tok-n">DWORD</span> <span class="tok-n">SecurityDescriptorSizeNeeded</span><span class="tok-p">;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">GetKernelObjectSecurity</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span>
        <span class="tok-n">OWNER_SECURITY_INFORMATION</span> <span class="tok-o">|</span> <span class="tok-n">GROUP_SECURITY_INFORMATION</span> <span class="tok-o">|</span> <span class="tok-n">DACL_SECURITY_INFORMATION</span><span class="tok-p">,</span>
        <span class="tok-n">SecurityDescriptor</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-n">DWORD</span><span class="tok-p">)</span><span class="tok-o">*</span><span class="tok-n">PSecurityDescriptorSize</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">SecurityDescriptorSizeNeeded</span><span class="tok-p">))</span>
    <span class="tok-p">{</span>
        <span class="tok-o">*</span><span class="tok-n">PSecurityDescriptorSize</span> <span class="tok-o">=</span> <span class="tok-n">SecurityDescriptorSizeNeeded</span><span class="tok-p">;</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>
    <span class="tok-p">}</span>

    <span class="tok-o">*</span><span class="tok-n">PSecurityDescriptorSize</span> <span class="tok-o">=</span> <span class="tok-n">SecurityDescriptorSizeNeeded</span><span class="tok-p">;</span>

    <span class="tok-k">return</span> <span class="tok-n">STATUS_SUCCESS</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_read_write">Read / Write</h3>
<div class="paragraph">
<p>Files in our file system can now be listed (<code>ReadDirectory</code>) and queried for their metadata (<code>GetFileInfo</code>, <code>GetSecurity</code>). However files cannot be read or written yet!</p>
</div>
<div class="paragraph">
<p>Implementing <code>Read</code> is simple for our file system. Here is the implementation.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>Read</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">Read</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">FileContext</span><span class="tok-p">,</span> <span class="tok-n">PVOID</span> <span class="tok-n">Buffer</span><span class="tok-p">,</span> <span class="tok-n">UINT64</span> <span class="tok-n">Offset</span><span class="tok-p">,</span> <span class="tok-n">ULONG</span> <span class="tok-n">Length</span><span class="tok-p">,</span>
    <span class="tok-n">PULONG</span> <span class="tok-n">PBytesTransferred</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">HandleFromContext</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>
    <span class="tok-n">OVERLAPPED</span> <span class="tok-n">Overlapped</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-mi">0</span> <span class="tok-p">};</span>

    <span class="tok-n">Overlapped</span><span class="tok-p">.</span><span class="tok-n">Offset</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">DWORD</span><span class="tok-p">)</span><span class="tok-n">Offset</span><span class="tok-p">;</span>                                  // <b class="conum">(1)</b>
    <span class="tok-n">Overlapped</span><span class="tok-p">.</span><span class="tok-n">OffsetHigh</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">DWORD</span><span class="tok-p">)(</span><span class="tok-n">Offset</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">32</span><span class="tok-p">);</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">ReadFile</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-n">Buffer</span><span class="tok-p">,</span> <span class="tok-n">Length</span><span class="tok-p">,</span> <span class="tok-n">PBytesTransferred</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">Overlapped</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

    <span class="tok-k">return</span> <span class="tok-n">STATUS_SUCCESS</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Specify the <code>Offset</code> to read in an <code>OVERLAPPED</code> structure.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Implementing <code>Write</code> is also simple, although more involved. This is because <code>Write</code> has more complex semantics and supports a <code>ConstrainedIo</code> mode in which the file system is not allowed to extend the file size during a <code>Write</code>.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>Write</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">Write</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">FileContext</span><span class="tok-p">,</span> <span class="tok-n">PVOID</span> <span class="tok-n">Buffer</span><span class="tok-p">,</span> <span class="tok-n">UINT64</span> <span class="tok-n">Offset</span><span class="tok-p">,</span> <span class="tok-n">ULONG</span> <span class="tok-n">Length</span><span class="tok-p">,</span>
    <span class="tok-n">BOOLEAN</span> <span class="tok-n">WriteToEndOfFile</span><span class="tok-p">,</span> <span class="tok-n">BOOLEAN</span> <span class="tok-n">ConstrainedIo</span><span class="tok-p">,</span>
    <span class="tok-n">PULONG</span> <span class="tok-n">PBytesTransferred</span><span class="tok-p">,</span> <span class="tok-n">FSP_FSCTL_FILE_INFO</span> <span class="tok-o">*</span><span class="tok-n">FileInfo</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">HandleFromContext</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>
    <span class="tok-n">LARGE_INTEGER</span> <span class="tok-n">FileSize</span><span class="tok-p">;</span>
    <span class="tok-n">OVERLAPPED</span> <span class="tok-n">Overlapped</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-mi">0</span> <span class="tok-p">};</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">ConstrainedIo</span><span class="tok-p">)</span>                                                  // <b class="conum">(1)</b>
    <span class="tok-p">{</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">GetFileSizeEx</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">FileSize</span><span class="tok-p">))</span>
            <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">Offset</span> <span class="tok-o">&gt;=</span> <span class="tok-p">(</span><span class="tok-n">UINT64</span><span class="tok-p">)</span><span class="tok-n">FileSize</span><span class="tok-p">.</span><span class="tok-n">QuadPart</span><span class="tok-p">)</span>
            <span class="tok-k">return</span> <span class="tok-n">STATUS_SUCCESS</span><span class="tok-p">;</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">Offset</span> <span class="tok-o">+</span> <span class="tok-n">Length</span> <span class="tok-o">&gt;</span> <span class="tok-p">(</span><span class="tok-n">UINT64</span><span class="tok-p">)</span><span class="tok-n">FileSize</span><span class="tok-p">.</span><span class="tok-n">QuadPart</span><span class="tok-p">)</span>
            <span class="tok-n">Length</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">ULONG</span><span class="tok-p">)((</span><span class="tok-n">UINT64</span><span class="tok-p">)</span><span class="tok-n">FileSize</span><span class="tok-p">.</span><span class="tok-n">QuadPart</span> <span class="tok-o">-</span> <span class="tok-n">Offset</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>

    <span class="tok-n">Overlapped</span><span class="tok-p">.</span><span class="tok-n">Offset</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">DWORD</span><span class="tok-p">)</span><span class="tok-n">Offset</span><span class="tok-p">;</span>                                  // <b class="conum">(2)</b>
    <span class="tok-n">Overlapped</span><span class="tok-p">.</span><span class="tok-n">OffsetHigh</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">DWORD</span><span class="tok-p">)(</span><span class="tok-n">Offset</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">32</span><span class="tok-p">);</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">WriteFile</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-n">Buffer</span><span class="tok-p">,</span> <span class="tok-n">Length</span><span class="tok-p">,</span> <span class="tok-n">PBytesTransferred</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">Overlapped</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

    <span class="tok-k">return</span> <span class="tok-n">GetFileInfoInternal</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-n">FileInfo</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>If <code>ConstrainedIo</code> is set we must restrict <code>Write</code> to not extend file size.</p>
</li>
<li>
<p>Specify the <code>Offset</code> to write in an <code>OVERLAPPED</code> structure. Note that the <code>Offset</code> will be <code>(UINT64)-1</code> when <code>WriteToEndOfFile</code> is set, which achieves the desired effect.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_setbasicinfo_setfilesize_setsecurity">SetBasicInfo / SetFileSize / SetSecurity</h3>
<div class="paragraph">
<p>Along with the ability to write a file, we also want the ability to update its metadata. This is accomplished by implementing the <code>SetBasicInfo</code>, <code>SetFileSize</code>, and <code>SetSecurity</code> operations. [The <code>SetSecurity</code> operation is not necessary if the file system does not support ACL&#8217;s.]</p>
</div>
<div class="paragraph">
<p>The <code>SetBasicInfo</code> operation is used to update a file&#8217;s attributes and times. The implementation follows:</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>SetBasicInfo</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">SetBasicInfo</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">FileContext</span><span class="tok-p">,</span> <span class="tok-n">UINT32</span> <span class="tok-n">FileAttributes</span><span class="tok-p">,</span>
    <span class="tok-n">UINT64</span> <span class="tok-n">CreationTime</span><span class="tok-p">,</span> <span class="tok-n">UINT64</span> <span class="tok-n">LastAccessTime</span><span class="tok-p">,</span> <span class="tok-n">UINT64</span> <span class="tok-n">LastWriteTime</span><span class="tok-p">,</span> <span class="tok-n">UINT64</span> <span class="tok-n">ChangeTime</span><span class="tok-p">,</span>
    <span class="tok-n">FSP_FSCTL_FILE_INFO</span> <span class="tok-o">*</span><span class="tok-n">FileInfo</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">HandleFromContext</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>
    <span class="tok-n">FILE_BASIC_INFO</span> <span class="tok-n">BasicInfo</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-mi">0</span> <span class="tok-p">};</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">INVALID_FILE_ATTRIBUTES</span> <span class="tok-o">==</span> <span class="tok-n">FileAttributes</span><span class="tok-p">)</span>
        <span class="tok-n">FileAttributes</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-k">else</span> <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">==</span> <span class="tok-n">FileAttributes</span><span class="tok-p">)</span>
        <span class="tok-n">FileAttributes</span> <span class="tok-o">=</span> <span class="tok-n">FILE_ATTRIBUTE_NORMAL</span><span class="tok-p">;</span>

    <span class="tok-n">BasicInfo</span><span class="tok-p">.</span><span class="tok-n">FileAttributes</span> <span class="tok-o">=</span> <span class="tok-n">FileAttributes</span><span class="tok-p">;</span>
    <span class="tok-n">BasicInfo</span><span class="tok-p">.</span><span class="tok-n">CreationTime</span><span class="tok-p">.</span><span class="tok-n">QuadPart</span> <span class="tok-o">=</span> <span class="tok-n">CreationTime</span><span class="tok-p">;</span>
    <span class="tok-n">BasicInfo</span><span class="tok-p">.</span><span class="tok-n">LastAccessTime</span><span class="tok-p">.</span><span class="tok-n">QuadPart</span> <span class="tok-o">=</span> <span class="tok-n">LastAccessTime</span><span class="tok-p">;</span>
    <span class="tok-n">BasicInfo</span><span class="tok-p">.</span><span class="tok-n">LastWriteTime</span><span class="tok-p">.</span><span class="tok-n">QuadPart</span> <span class="tok-o">=</span> <span class="tok-n">LastWriteTime</span><span class="tok-p">;</span>
    <span class="tok-c1">//BasicInfo.ChangeTime = ChangeTime;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">SetFileInformationByHandle</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span>
        <span class="tok-n">FileBasicInfo</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">BasicInfo</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-n">BasicInfo</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

    <span class="tok-k">return</span> <span class="tok-n">GetFileInfoInternal</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-n">FileInfo</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>SetFileSize</code> operation is used to change a file&#8217;s sizes. Files in a Windows file system can have two sizes: an "EndOfFile" size or <code>FileSize</code> and an <code>AllocationSize</code>. The <code>FileSize</code> is the number of bytes contained in a file. The <code>AllocationSize</code> is a concept that many file systems can safely ignore (or not expose to the kernel): it is the actual number of bytes that a file occupies on its storage medium.</p>
</div>
<div class="paragraph">
<p>Although some file systems may have an internal block / chunk / cluster / sector that they use as their basic <code>AllocationUnit</code>, it is not necessary to expose this information to the kernel. The advantage to exposing it is that applications can use (little documented) file system API&#8217;s to preallocate files.</p>
</div>
<div class="paragraph">
<p>Regardless of whether a file system exposes <code>AllocationSize</code> it must obey the following rule: it must always be that <code>FileSize &lt;= AllocationSize</code>. In general the WinFsp driver also assumes that the <code>AllocationSize</code> is a multiple of the <code>AllocationUnit</code>; in this case the <code>AllocationUnit</code> is the product of <code>SectorSize * SectorsPerAllocationUnit</code>.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>SetFileSize</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">SetFileSize</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">FileContext</span><span class="tok-p">,</span> <span class="tok-n">UINT64</span> <span class="tok-n">NewSize</span><span class="tok-p">,</span> <span class="tok-n">BOOLEAN</span> <span class="tok-n">SetAllocationSize</span><span class="tok-p">,</span>
    <span class="tok-n">FSP_FSCTL_FILE_INFO</span> <span class="tok-o">*</span><span class="tok-n">FileInfo</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">HandleFromContext</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>
    <span class="tok-n">FILE_ALLOCATION_INFO</span> <span class="tok-n">AllocationInfo</span><span class="tok-p">;</span>
    <span class="tok-n">FILE_END_OF_FILE_INFO</span> <span class="tok-n">EndOfFileInfo</span><span class="tok-p">;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">SetAllocationSize</span><span class="tok-p">)</span>
    <span class="tok-p">{</span>
        <span class="tok-cm">/*</span>
<span class="tok-cm">         * This file system does not maintain AllocationSize, although NTFS clearly can.</span>
<span class="tok-cm">         * However it must always be FileSize &lt;= AllocationSize and NTFS will make sure</span>
<span class="tok-cm">         * to truncate the FileSize if it sees an AllocationSize &lt; FileSize.</span>
<span class="tok-cm">         *</span>
<span class="tok-cm">         * If OTOH a very large AllocationSize is passed, the call below will increase</span>
<span class="tok-cm">         * the AllocationSize of the underlying file, although our file system does not</span>
<span class="tok-cm">         * expose this fact. This AllocationSize is only temporary as NTFS will reset</span>
<span class="tok-cm">         * the AllocationSize of the underlying file when it is closed.</span>
<span class="tok-cm">         */</span>

        <span class="tok-n">AllocationInfo</span><span class="tok-p">.</span><span class="tok-n">AllocationSize</span><span class="tok-p">.</span><span class="tok-n">QuadPart</span> <span class="tok-o">=</span> <span class="tok-n">NewSize</span><span class="tok-p">;</span>

        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">SetFileInformationByHandle</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span>
            <span class="tok-n">FileAllocationInfo</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">AllocationInfo</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-n">AllocationInfo</span><span class="tok-p">))</span>
            <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>
    <span class="tok-p">}</span>
    <span class="tok-k">else</span>
    <span class="tok-p">{</span>
        <span class="tok-n">EndOfFileInfo</span><span class="tok-p">.</span><span class="tok-n">EndOfFile</span><span class="tok-p">.</span><span class="tok-n">QuadPart</span> <span class="tok-o">=</span> <span class="tok-n">NewSize</span><span class="tok-p">;</span>

        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">SetFileInformationByHandle</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span>
            <span class="tok-n">FileEndOfFileInfo</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">EndOfFileInfo</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-n">EndOfFileInfo</span><span class="tok-p">))</span>
            <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>
    <span class="tok-p">}</span>

    <span class="tok-k">return</span> <span class="tok-n">GetFileInfoInternal</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-n">FileInfo</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally the <code>SetSecurity</code> operation is used to update a file&#8217;s security information.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>SetSecurity</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">SetSecurity</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">FileContext</span><span class="tok-p">,</span>
    <span class="tok-n">SECURITY_INFORMATION</span> <span class="tok-n">SecurityInformation</span><span class="tok-p">,</span> <span class="tok-n">PSECURITY_DESCRIPTOR</span> <span class="tok-n">ModificationDescriptor</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">HandleFromContext</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">SetKernelObjectSecurity</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-n">SecurityInformation</span><span class="tok-p">,</span> <span class="tok-n">ModificationDescriptor</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

    <span class="tok-k">return</span> <span class="tok-n">STATUS_SUCCESS</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_flush">Flush</h3>
<div class="paragraph">
<p>Windows file systems are free to cache file information in order to speed up operations. In some cases it is important to ensure that all caches have been "flushed" and all information has been persisted in the final storage medium. Windows provides the <code>FlushFileBuffers</code> API for this purpose. User mode file systems that support flushing must implement the <code>Flush</code> operation.</p>
</div>
<div class="paragraph">
<p>The <code>Flush</code> operation is used to flush a single file or the whole volume (file system). At the time the <code>Flush</code> call arrives the kernel has already flushed all its file caches (by calling <code>Write</code> for all dirty data in its caches). If the file system performs additional caching it should flush its own caches at this point.</p>
</div>
<div class="paragraph">
<p>The implementation of <code>Flush</code> for our passthrough file system follows:</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>Flush</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-n">NTSTATUS</span> <span class="tok-nf">Flush</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">FileContext</span><span class="tok-p">,</span>
    <span class="tok-n">FSP_FSCTL_FILE_INFO</span> <span class="tok-o">*</span><span class="tok-n">FileInfo</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">HandleFromContext</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>

    <span class="tok-cm">/* we do not flush the whole volume, so just return SUCCESS */</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">==</span> <span class="tok-n">Handle</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">STATUS_SUCCESS</span><span class="tok-p">;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">FlushFileBuffers</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

    <span class="tok-k">return</span> <span class="tok-n">GetFileInfoInternal</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-n">FileInfo</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create">Create</h3>
<div class="paragraph">
<p>Our file system is now functional, but it still misses an important ability: the ability to create and delete files. We will tackle creating files first.</p>
</div>
<div class="paragraph">
<p>The <code>Create</code> operation is used to create files and directories. A file or directory should be created only if it does not already exist. Whether to create a file or directory is controlled by the <code>FILE_DIRECTORY_FILE</code> flag.</p>
</div>
<div class="paragraph">
<p>The implementation of <code>Create</code> follows:</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>Create</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">Create</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PWSTR</span> <span class="tok-n">FileName</span><span class="tok-p">,</span> <span class="tok-n">UINT32</span> <span class="tok-n">CreateOptions</span><span class="tok-p">,</span> <span class="tok-n">UINT32</span> <span class="tok-n">GrantedAccess</span><span class="tok-p">,</span>
    <span class="tok-n">UINT32</span> <span class="tok-n">FileAttributes</span><span class="tok-p">,</span> <span class="tok-n">PSECURITY_DESCRIPTOR</span> <span class="tok-n">SecurityDescriptor</span><span class="tok-p">,</span> <span class="tok-n">UINT64</span> <span class="tok-n">AllocationSize</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-o">*</span><span class="tok-n">PFileContext</span><span class="tok-p">,</span> <span class="tok-n">FSP_FSCTL_FILE_INFO</span> <span class="tok-o">*</span><span class="tok-n">FileInfo</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-n">Ptfs</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">FileSystem</span><span class="tok-o">-&gt;</span><span class="tok-n">UserContext</span><span class="tok-p">;</span>
    <span class="tok-n">WCHAR</span> <span class="tok-n">FullPath</span><span class="tok-p">[</span><span class="tok-n">FULLPATH_SIZE</span><span class="tok-p">];</span>
    <span class="tok-n">SECURITY_ATTRIBUTES</span> <span class="tok-n">SecurityAttributes</span><span class="tok-p">;</span>
    <span class="tok-n">ULONG</span> <span class="tok-n">CreateFlags</span><span class="tok-p">;</span>
    <span class="tok-n">PTFS_FILE_CONTEXT</span> <span class="tok-o">*</span><span class="tok-n">FileContext</span><span class="tok-p">;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">ConcatPath</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-p">,</span> <span class="tok-n">FileName</span><span class="tok-p">,</span> <span class="tok-n">FullPath</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">STATUS_OBJECT_NAME_INVALID</span><span class="tok-p">;</span>

    <span class="tok-n">FileContext</span> <span class="tok-o">=</span> <span class="tok-n">malloc</span><span class="tok-p">(</span><span class="tok-k">sizeof</span> <span class="tok-o">*</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>                          // <b class="conum">(1)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">==</span> <span class="tok-n">FileContext</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">STATUS_INSUFFICIENT_RESOURCES</span><span class="tok-p">;</span>
    <span class="tok-n">memset</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-o">*</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>

    <span class="tok-n">SecurityAttributes</span><span class="tok-p">.</span><span class="tok-n">nLength</span> <span class="tok-o">=</span> <span class="tok-k">sizeof</span> <span class="tok-n">SecurityAttributes</span><span class="tok-p">;</span>
    <span class="tok-n">SecurityAttributes</span><span class="tok-p">.</span><span class="tok-n">lpSecurityDescriptor</span> <span class="tok-o">=</span> <span class="tok-n">SecurityDescriptor</span><span class="tok-p">;</span>
    <span class="tok-n">SecurityAttributes</span><span class="tok-p">.</span><span class="tok-n">bInheritHandle</span> <span class="tok-o">=</span> <span class="tok-n">FALSE</span><span class="tok-p">;</span>

    <span class="tok-n">CreateFlags</span> <span class="tok-o">=</span> <span class="tok-n">FILE_FLAG_BACKUP_SEMANTICS</span><span class="tok-p">;</span>                           // <b class="conum">(2)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">CreateOptions</span> <span class="tok-o">&amp;</span> <span class="tok-n">FILE_DELETE_ON_CLOSE</span><span class="tok-p">)</span>
        <span class="tok-n">CreateFlags</span> <span class="tok-o">|=</span> <span class="tok-n">FILE_FLAG_DELETE_ON_CLOSE</span><span class="tok-p">;</span>                       // <b class="conum">(3)</b>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">CreateOptions</span> <span class="tok-o">&amp;</span> <span class="tok-n">FILE_DIRECTORY_FILE</span><span class="tok-p">)</span>
    <span class="tok-p">{</span>
        <span class="tok-cm">/*</span>
<span class="tok-cm">         * It is not widely known but CreateFileW can be used to create directories!</span>
<span class="tok-cm">         * It requires the specification of both FILE_FLAG_BACKUP_SEMANTICS and</span>
<span class="tok-cm">         * FILE_FLAG_POSIX_SEMANTICS. It also requires that FileAttributes has</span>
<span class="tok-cm">         * FILE_ATTRIBUTE_DIRECTORY set.</span>
<span class="tok-cm">         */</span>
        <span class="tok-n">CreateFlags</span> <span class="tok-o">|=</span> <span class="tok-n">FILE_FLAG_POSIX_SEMANTICS</span><span class="tok-p">;</span>                       // <b class="conum">(2)</b>
        <span class="tok-n">FileAttributes</span> <span class="tok-o">|=</span> <span class="tok-n">FILE_ATTRIBUTE_DIRECTORY</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-k">else</span>
        <span class="tok-n">FileAttributes</span> <span class="tok-o">&amp;=</span> <span class="tok-o">~</span><span class="tok-n">FILE_ATTRIBUTE_DIRECTORY</span><span class="tok-p">;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">==</span> <span class="tok-n">FileAttributes</span><span class="tok-p">)</span>
        <span class="tok-n">FileAttributes</span> <span class="tok-o">=</span> <span class="tok-n">FILE_ATTRIBUTE_NORMAL</span><span class="tok-p">;</span>

    <span class="tok-n">FileContext</span><span class="tok-o">-&gt;</span><span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">CreateFileW</span><span class="tok-p">(</span><span class="tok-n">FullPath</span><span class="tok-p">,</span>
        <span class="tok-n">GrantedAccess</span><span class="tok-p">,</span> <span class="tok-n">FILE_SHARE_READ</span> <span class="tok-o">|</span> <span class="tok-n">FILE_SHARE_WRITE</span> <span class="tok-o">|</span> <span class="tok-n">FILE_SHARE_DELETE</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">SecurityAttributes</span><span class="tok-p">,</span>
        <span class="tok-n">CREATE_NEW</span><span class="tok-p">,</span> <span class="tok-n">CreateFlags</span> <span class="tok-o">|</span> <span class="tok-n">FileAttributes</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>                   // <b class="conum">(4)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">INVALID_HANDLE_VALUE</span> <span class="tok-o">==</span> <span class="tok-n">FileContext</span><span class="tok-o">-&gt;</span><span class="tok-n">Handle</span><span class="tok-p">)</span>
    <span class="tok-p">{</span>
        <span class="tok-n">free</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>
    <span class="tok-p">}</span>

    <span class="tok-o">*</span><span class="tok-n">PFileContext</span> <span class="tok-o">=</span> <span class="tok-n">FileContext</span><span class="tok-p">;</span>

    <span class="tok-k">return</span> <span class="tok-n">GetFileInfoInternal</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-o">-&gt;</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-n">FileInfo</span><span class="tok-p">);</span>          // <b class="conum">(5)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Create the <code>FileContext</code> object. This is used to track an open file instance.</p>
</li>
<li>
<p>Allow creation of directories using the flags <code>FILE_FLAG_BACKUP_SEMANTICS | FILE_FLAG_POSIX_SEMANTICS</code>.</p>
</li>
<li>
<p>Include the FILE_FLAG_DELETE_ON_CLOSE flag. File systems do not normally have to track this flag as WinFsp will track it and post the appropriate <code>Cleanup</code> request. Passing it to the underlying file system here allows us to simplify <code>Cleanup</code> for this simple file system.</p>
</li>
<li>
<p>Use CREATE_NEW to create new files only. Allow full sharing (<code>FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE</code>) as WinFsp performs its own sharing checks.</p>
</li>
<li>
<p>Use <code>GetFileInfoInternal</code> to return information about the file.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_overwrite">Overwrite</h3>
<div class="paragraph">
<p>Another special operation for Windows file systems is the ability to "overwrite" or "supersede" files. This operation is used (for example) when an application calls <code>CreateFileW</code> with the <code>CREATE_ALWAYS</code> flag.</p>
</div>
<div class="paragraph">
<p><code>Overwrite</code> must truncate the file to zero size. It must also replace or merge the file&#8217;s attributes according to the <code>ReplaceFileAttributes</code> parameter. The implementation of <code>Overwrite</code> for our file system follows.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>Overwrite</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">Overwrite</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">FileContext</span><span class="tok-p">,</span> <span class="tok-n">UINT32</span> <span class="tok-n">FileAttributes</span><span class="tok-p">,</span> <span class="tok-n">BOOLEAN</span> <span class="tok-n">ReplaceFileAttributes</span><span class="tok-p">,</span> <span class="tok-n">UINT64</span> <span class="tok-n">AllocationSize</span><span class="tok-p">,</span>
    <span class="tok-n">FSP_FSCTL_FILE_INFO</span> <span class="tok-o">*</span><span class="tok-n">FileInfo</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">HandleFromContext</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>
    <span class="tok-n">FILE_BASIC_INFO</span> <span class="tok-n">BasicInfo</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-mi">0</span> <span class="tok-p">};</span>
    <span class="tok-n">FILE_ALLOCATION_INFO</span> <span class="tok-n">AllocationInfo</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-mi">0</span> <span class="tok-p">};</span>
    <span class="tok-n">FILE_ATTRIBUTE_TAG_INFO</span> <span class="tok-n">AttributeTagInfo</span><span class="tok-p">;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">ReplaceFileAttributes</span><span class="tok-p">)</span>
    <span class="tok-p">{</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">==</span> <span class="tok-n">FileAttributes</span><span class="tok-p">)</span>
            <span class="tok-n">FileAttributes</span> <span class="tok-o">=</span> <span class="tok-n">FILE_ATTRIBUTE_NORMAL</span><span class="tok-p">;</span>

        <span class="tok-n">BasicInfo</span><span class="tok-p">.</span><span class="tok-n">FileAttributes</span> <span class="tok-o">=</span> <span class="tok-n">FileAttributes</span><span class="tok-p">;</span>                      // <b class="conum">(1)</b>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">SetFileInformationByHandle</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span>
            <span class="tok-n">FileBasicInfo</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">BasicInfo</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-n">BasicInfo</span><span class="tok-p">))</span>
            <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>
    <span class="tok-p">}</span>
    <span class="tok-k">else</span> <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">!=</span> <span class="tok-n">FileAttributes</span><span class="tok-p">)</span>
    <span class="tok-p">{</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">GetFileInformationByHandleEx</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span>
            <span class="tok-n">FileAttributeTagInfo</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">AttributeTagInfo</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-n">AttributeTagInfo</span><span class="tok-p">))</span>
            <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

        <span class="tok-n">BasicInfo</span><span class="tok-p">.</span><span class="tok-n">FileAttributes</span> <span class="tok-o">=</span>
            <span class="tok-n">FileAttributes</span> <span class="tok-o">|</span> <span class="tok-n">AttributeTagInfo</span><span class="tok-p">.</span><span class="tok-n">FileAttributes</span><span class="tok-p">;</span>           // <b class="conum">(2)</b>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">BasicInfo</span><span class="tok-p">.</span><span class="tok-n">FileAttributes</span> <span class="tok-o">^</span> <span class="tok-n">FileAttributes</span><span class="tok-p">)</span>
        <span class="tok-p">{</span>
            <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">SetFileInformationByHandle</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span>
                <span class="tok-n">FileBasicInfo</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">BasicInfo</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-n">BasicInfo</span><span class="tok-p">))</span>
                <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>
        <span class="tok-p">}</span>
    <span class="tok-p">}</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">SetFileInformationByHandle</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span>
        <span class="tok-n">FileAllocationInfo</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">AllocationInfo</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-n">AllocationInfo</span><span class="tok-p">))</span>    // <b class="conum">(3)</b>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

    <span class="tok-k">return</span> <span class="tok-n">GetFileInfoInternal</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span> <span class="tok-n">FileInfo</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>If <code>ReplaceFileAttributes</code> is true, set the file&#8217;s attributets to the specified ones (this is a "supersede" operation).</p>
</li>
<li>
<p>If <code>ReplaceFileAttributes</code> is false, merge the specified file attributes with the existing ones (this is an "overwrite" operation).</p>
</li>
<li>
<p>Set the underlying file&#8217;s allocation size to 0, which also sets the file size to 0, thus truncating the file.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_cleanup">Cleanup</h3>
<div class="paragraph">
<p>One of the important file system operations that we have not discussed so far is <code>Cleanup</code>. <code>Cleanup</code> is called whenever a file is about to be closed (when an application that opened a file calls <code>CloseHandle</code>). If the <code>VolumeParams</code> <code>PostCleanupWhenModifiedOnly</code> flag is set, then <code>Cleanup</code> is posted only when the file was modified or deleted. As such <code>Cleanup</code> support is essential if a file system supports deleting files.</p>
</div>
<div class="paragraph">
<p>Our <code>Cleanup</code> implementation is minimal. We present it below and we discuss it afterwards.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>Cleanup</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">VOID</span> <span class="tok-nf">Cleanup</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">FileContext</span><span class="tok-p">,</span> <span class="tok-n">PWSTR</span> <span class="tok-n">FileName</span><span class="tok-p">,</span> <span class="tok-n">ULONG</span> <span class="tok-n">Flags</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">HandleFromContext</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">Flags</span> <span class="tok-o">&amp;</span> <span class="tok-n">FspCleanupDelete</span><span class="tok-p">)</span>                                       // <b class="conum">(1)</b>
    <span class="tok-p">{</span>
        <span class="tok-n">CloseHandle</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">);</span>

        <span class="tok-cm">/* this will make all future uses of Handle to fail with STATUS_INVALID_HANDLE */</span>
        <span class="tok-n">HandleFromContext</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">)</span> <span class="tok-o">=</span> <span class="tok-n">INVALID_HANDLE_VALUE</span><span class="tok-p">;</span>          // <b class="conum">(2)</b>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Only close the underlying file&#8217;s handle if our file system&#8217;s file instance has been marked for deletion.</p>
</li>
<li>
<p>This invalidates the underlying file&#8217;s handle, thus ensuring that additional file operations will fail with <code>STATUS_INVALID_HANDLE</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If our open file instance is not marked for deletion we do <strong>not</strong> <code>CloseHandle</code> the underlying handle; we will do so at a later time when we receive the <code>Close</code> request. This allows the file system to receive additional requests (for example, <code>Write</code> requests from the kernel lazy writer if kernel caching is enabled for this file system).</p>
</div>
<div class="paragraph">
<p>If our open file instance is marked for deletion we <code>CloseHandle</code> the underlying handle, and we invalidate the handle. By calling <code>CloseHandle</code> we ensure that the underlying file system can now delete a file that has been previously marked for deletion by the <code>FILE_FLAG_DELETE_ON_CLOSE</code> flag or a <code>FileDispositionInfo</code> call (see <code>CanDelete</code> below). By invalidating the handle we ensure that no additional file operations can be performed on this file instance (they will fail with <code>STATUS_INVALID_HANDLE</code>). We will still receive a <code>Close</code> operation for our open file instance which calls <code>CloseHandle</code> again, but this is safe to do with INVALID_HANDLE_VALUE.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The WinFsp kernel driver maintains a <code>DeletePending</code> flag for every open file. This flag becomes true when a file is opened with <code>FILE_FLAG_DELETE_ON_CLOSE</code> or when <code>FileDispositionInfo</code> is set. The WinFsp kernel driver sets <code>FspCleanupDelete</code> when it receives the last <code>CloseHandle</code> for a file that is being deleted. The user mode file system need not maintain its own <code>DeletePending</code> flag.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_candelete">CanDelete</h3>
<div class="paragraph">
<p>There are two ways for deleting a file or directory on Windows. One is to supply the <code>FILE_FLAG_DELETE_ON_CLOSE</code> flag during a <code>CreateFileW</code> call. The other one is to use the <code>FileDispositionInfo</code> information class with a call to <code>SetInformationByHandle</code> (which is what <code>DeleteFileW</code> and <code>RemoveDirectoryW</code> effectively do). [It is also possible to delete an (unopened) file using <code>Rename</code> by we will ignore this case here.]</p>
</div>
<div class="paragraph">
<p><code>CanDelete</code> is called in the <code>FileDispositionInfo</code> case (only). In general <code>CanDelete</code> needs to check whether deleting the file or directory is allowed and return <code>STATUS_SUCCESS</code> or an appropriate status code. Most file systems need only check whether a directory is empty and disallow deletion by returning <code>STATUS_DIRECTORY_NOT_EMPTY</code> if it is not. <code>CanDelete</code> need <strong>not</strong> mark a file for deletion, this flag is maintained by the WinFsp kernel driver.</p>
</div>
<div class="paragraph">
<p>In this implementation of <code>CanDelete</code> we take advantage of the fact that the underlying Windows file system already knows how to handle a <code>FileDispositionInfo</code> call.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>CanDelete</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">CanDelete</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">FileContext</span><span class="tok-p">,</span> <span class="tok-n">PWSTR</span> <span class="tok-n">FileName</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Handle</span> <span class="tok-o">=</span> <span class="tok-n">HandleFromContext</span><span class="tok-p">(</span><span class="tok-n">FileContext</span><span class="tok-p">);</span>
    <span class="tok-n">FILE_DISPOSITION_INFO</span> <span class="tok-n">DispositionInfo</span><span class="tok-p">;</span>

    <span class="tok-n">DispositionInfo</span><span class="tok-p">.</span><span class="tok-n">DeleteFile</span> <span class="tok-o">=</span> <span class="tok-n">TRUE</span><span class="tok-p">;</span>                                  // <b class="conum">(1)</b>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">SetFileInformationByHandle</span><span class="tok-p">(</span><span class="tok-n">Handle</span><span class="tok-p">,</span>
        <span class="tok-n">FileDispositionInfo</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">DispositionInfo</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span> <span class="tok-n">DispositionInfo</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

    <span class="tok-k">return</span> <span class="tok-n">STATUS_SUCCESS</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Mark the underlying file system&#8217;s file for deletion.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_rename">Rename</h3>
<div class="paragraph">
<p>Our file system is almost fully functional. There remains one operation to implement: <code>Rename</code>.</p>
</div>
<div class="paragraph">
<p><code>Rename</code> can be hard to implement for a general purpose file system, but in our case things are simple, because the underlying Windows file system will take care of the details.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>Rename</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">Rename</span><span class="tok-p">(</span><span class="tok-n">FSP_FILE_SYSTEM</span> <span class="tok-o">*</span><span class="tok-n">FileSystem</span><span class="tok-p">,</span>
    <span class="tok-n">PVOID</span> <span class="tok-n">FileContext</span><span class="tok-p">,</span>
    <span class="tok-n">PWSTR</span> <span class="tok-n">FileName</span><span class="tok-p">,</span> <span class="tok-n">PWSTR</span> <span class="tok-n">NewFileName</span><span class="tok-p">,</span> <span class="tok-n">BOOLEAN</span> <span class="tok-n">ReplaceIfExists</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-n">Ptfs</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">PTFS</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">FileSystem</span><span class="tok-o">-&gt;</span><span class="tok-n">UserContext</span><span class="tok-p">;</span>
    <span class="tok-n">WCHAR</span> <span class="tok-n">FullPath</span><span class="tok-p">[</span><span class="tok-n">FULLPATH_SIZE</span><span class="tok-p">],</span> <span class="tok-n">NewFullPath</span><span class="tok-p">[</span><span class="tok-n">FULLPATH_SIZE</span><span class="tok-p">];</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">ConcatPath</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-p">,</span> <span class="tok-n">FileName</span><span class="tok-p">,</span> <span class="tok-n">FullPath</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">STATUS_OBJECT_NAME_INVALID</span><span class="tok-p">;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">ConcatPath</span><span class="tok-p">(</span><span class="tok-n">Ptfs</span><span class="tok-p">,</span> <span class="tok-n">NewFileName</span><span class="tok-p">,</span> <span class="tok-n">NewFullPath</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">STATUS_OBJECT_NAME_INVALID</span><span class="tok-p">;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">MoveFileExW</span><span class="tok-p">(</span><span class="tok-n">FullPath</span><span class="tok-p">,</span> <span class="tok-n">NewFullPath</span><span class="tok-p">,</span> <span class="tok-n">ReplaceIfExists</span> <span class="tok-o">?</span> <span class="tok-nl">MOVEFILE_REPLACE_EXISTING</span> <span class="tok-p">:</span> <span class="tok-mi">0</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

    <span class="tok-k">return</span> <span class="tok-n">STATUS_SUCCESS</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_the_file_system">Testing the file system</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We now have a functional file system. It supports the following Windows file system functionality:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Query volume information.</p>
</li>
<li>
<p>Open, create, close, delete, rename files and directories.</p>
</li>
<li>
<p>Query and set file and directory information.</p>
</li>
<li>
<p>Query and set security information (ACL&#8217;s).</p>
</li>
<li>
<p>Read and write files.</p>
</li>
<li>
<p>Memory mapped I/O.</p>
</li>
<li>
<p>Directory change notifications.</p>
</li>
<li>
<p>Lock and unlock files.</p>
</li>
<li>
<p>Opportunistic locks.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>There is some additional functionality which WinFsp supports but our file system does not implement:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open, create, close, delete, query named streams.</p>
</li>
<li>
<p>Reparse points and symbolic links.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The question is: how can we develop the confidence that our file system works as a "proper" Windows file system?</p>
</div>
<div class="paragraph">
<p>WinFsp includes a number of test suites that are used for testing its components and its reference file system MEMFS. The primary test suite is called <code>winfsp-tests</code> and is a comprehensive test suite that exercises all aspects of Windows file system functionality that WinFsp supports. <code>Winfsp-tests</code> can be run in a special <code>--external</code> mode where it can be used to test other WinFsp-based file systems. We will use it in this case to test our passthrough file system.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>Winfsp-tests</code> is not included with the WinFsp installer. In order to use <code>winfsp-tests</code> one must first clone the WinFsp repository and build the WinFsp Visual Studio solution. The steps to do so are not included in this tutorial.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>Winfsp-tests</code> exercises some esoteric aspects of Windows file system functionality, so we do not expect all the tests to pass. For example, our simple file system does not maintain <code>AllocationSize</code>; we therefore expect related tests to fail. As another example, the passthrough file system uses normal Windows file API&#8217;s to implement its functionality, as such some security tests are expected to fail if the file system runs under a normal account.</p>
</div>
<div class="paragraph">
<p>In order to test our file system we create a drive <code>Y:</code> using the command line <code>passthrough-x64 -p C:\...\passthrough-x64 -m Y:</code> and then execute the command.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>winfsp-tests run</strong></code></div>
<div class="content">
<pre>Y:\&gt;C:\...\winfsp-tests-x64 --external --resilient --case-insensitive-cmp -create_allocation_test -getfileinfo_name_test -delete_access_test -rename_flipflop_test -rename_mmap_test -reparse* -stream* <b class="conum">(1)</b> <b class="conum">(2)</b>
[snip irrelevant tests]
create_test............................ OK 0.03s
create_related_test.................... OK 0.00s
create_sd_test......................... OK 0.03s
create_notraverse_test................. OK 0.00s
create_backup_test..................... OK 0.00s
create_restore_test.................... OK 0.00s
create_share_test...................... OK 0.00s
create_curdir_test..................... OK 0.00s
create_namelen_test.................... OK 0.02s
getfileinfo_test....................... OK 0.00s
setfileinfo_test....................... OK 0.01s
delete_test............................ OK 0.00s
delete_pending_test.................... OK 0.00s
delete_mmap_test....................... OK 0.02s
rename_test............................ OK 0.06s
rename_open_test....................... OK 0.00s
rename_caseins_test.................... OK 0.02s
getvolinfo_test........................ OK 0.00s
setvolinfo_test........................ OK 0.00s
getsecurity_test....................... OK 0.00s
setsecurity_test....................... OK 0.01s
rdwr_noncached_test.................... OK 0.02s
rdwr_noncached_overlapped_test......... OK 0.03s
rdwr_cached_test....................... OK 0.02s
rdwr_cached_append_test................ OK 0.01s
rdwr_cached_overlapped_test............ OK 0.03s
rdwr_writethru_test.................... OK 0.06s
rdwr_writethru_append_test............. OK 0.01s
rdwr_writethru_overlapped_test......... OK 0.00s
rdwr_mmap_test......................... OK 0.23s
rdwr_mixed_test........................ OK 0.03s
flush_test............................. OK 0.06s
flush_volume_test...................... OK 0.00s
lock_noncached_test.................... OK 0.02s
lock_noncached_overlapped_test......... OK 0.02s
lock_cached_test....................... OK 0.05s
lock_cached_overlapped_test............ OK 0.02s
querydir_test.......................... OK 0.39s
querydir_expire_cache_test............. OK 0.00s
querydir_buffer_overflow_test.......... OK 0.00s
dirnotify_test......................... OK 1.01s
--- COMPLETE ---</pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Run <code>winfsp-tests</code> with <code>--external</code>, <code>--resilient</code> switches which instructs it to run its external file system tests.</p>
</li>
<li>
<p>Disable tests that are not expected to pass because they test functionality that either we did not implement (<code>-reparse*</code>, <code>-stream*</code>) or is esoteric (<code>-create_allocation_test</code>, <code>-getfileinfo_name_test</code>, <code>-rename_flipflop_test</code>, <code>-rename_mmap_test</code>) or requires that the file system is run under an account with sufficient security rights (<code>-delete_access_test</code>).</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_the_file_system_as_a_service">Running the file system as a service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our final task is to discuss how to convert our file system into a service that can be managed by the WinFsp launcher. This allows our file system to provide file services to all processes in the system.</p>
</div>
<div class="paragraph">
<p>An important thing to consider is that our file system will be running in the SYSTEM account security context, which is different from the security context of any processes that want to use this file system. Recall that the passthrough file system is a simple layer over an underlying file system, therefore how the underlying file system handles security becomes important, particularly when the underlying file system is NTFS.</p>
</div>
<div class="paragraph">
<p>For this reason we modify the passthrough file system to enable the "backup" and "restore" privileges which are available to a process running under the SYSTEM account. Enabling these privileges allows us to circumvent some NTFS access checks and simply use NTFS as a storage medium. With the <code>EnableBackupRestorePrivileges</code> implementation in place all that remains is to call it from <code>SvcStart</code>.</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>EnableBackupRestorePrivileges</strong></code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">static</span> <span class="tok-n">NTSTATUS</span> <span class="tok-nf">EnableBackupRestorePrivileges</span><span class="tok-p">(</span><span class="tok-n">VOID</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-k">union</span>
    <span class="tok-p">{</span>
        <span class="tok-n">TOKEN_PRIVILEGES</span> <span class="tok-n">P</span><span class="tok-p">;</span>
        <span class="tok-n">UINT8</span> <span class="tok-n">B</span><span class="tok-p">[</span><span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">TOKEN_PRIVILEGES</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">LUID_AND_ATTRIBUTES</span><span class="tok-p">)];</span>
    <span class="tok-p">}</span> <span class="tok-n">Privileges</span><span class="tok-p">;</span>
    <span class="tok-n">HANDLE</span> <span class="tok-n">Token</span><span class="tok-p">;</span>

    <span class="tok-n">Privileges</span><span class="tok-p">.</span><span class="tok-n">P</span><span class="tok-p">.</span><span class="tok-n">PrivilegeCount</span> <span class="tok-o">=</span> <span class="tok-mi">2</span><span class="tok-p">;</span>
    <span class="tok-n">Privileges</span><span class="tok-p">.</span><span class="tok-n">P</span><span class="tok-p">.</span><span class="tok-n">Privileges</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">].</span><span class="tok-n">Attributes</span> <span class="tok-o">=</span> <span class="tok-n">SE_PRIVILEGE_ENABLED</span><span class="tok-p">;</span>
    <span class="tok-n">Privileges</span><span class="tok-p">.</span><span class="tok-n">P</span><span class="tok-p">.</span><span class="tok-n">Privileges</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">].</span><span class="tok-n">Attributes</span> <span class="tok-o">=</span> <span class="tok-n">SE_PRIVILEGE_ENABLED</span><span class="tok-p">;</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">LookupPrivilegeValueW</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">SE_BACKUP_NAME</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">Privileges</span><span class="tok-p">.</span><span class="tok-n">P</span><span class="tok-p">.</span><span class="tok-n">Privileges</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">].</span><span class="tok-n">Luid</span><span class="tok-p">)</span> <span class="tok-o">||</span>
        <span class="tok-o">!</span><span class="tok-n">LookupPrivilegeValueW</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">SE_RESTORE_NAME</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">Privileges</span><span class="tok-p">.</span><span class="tok-n">P</span><span class="tok-p">.</span><span class="tok-n">Privileges</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">].</span><span class="tok-n">Luid</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">OpenProcessToken</span><span class="tok-p">(</span><span class="tok-n">GetCurrentProcess</span><span class="tok-p">(),</span> <span class="tok-n">TOKEN_ADJUST_PRIVILEGES</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">Token</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">AdjustTokenPrivileges</span><span class="tok-p">(</span><span class="tok-n">Token</span><span class="tok-p">,</span> <span class="tok-n">FALSE</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">Privileges</span><span class="tok-p">.</span><span class="tok-n">P</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">))</span>
    <span class="tok-p">{</span>
        <span class="tok-n">CloseHandle</span><span class="tok-p">(</span><span class="tok-n">Token</span><span class="tok-p">);</span>

        <span class="tok-k">return</span> <span class="tok-n">FspNtStatusFromWin32</span><span class="tok-p">(</span><span class="tok-n">GetLastError</span><span class="tok-p">());</span>
    <span class="tok-p">}</span>

    <span class="tok-n">CloseHandle</span><span class="tok-p">(</span><span class="tok-n">Token</span><span class="tok-p">);</span>

    <span class="tok-k">return</span> <span class="tok-n">STATUS_SUCCESS</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are now ready to register our file system to be managed by the WinFsp launcher. For this purpose we will use the <code>fsreg.bat</code> utility which can be found in the WinFsp <code>bin</code> directory. <code>Fsreg.bat</code> will create all necessary entries in the Windows registry.</p>
</div>
<div class="paragraph">
<p>From an administrator prompt switch to the passthrough directory and run:</p>
</div>
<div class="listingblock">
<div class="title"><code><strong>fsreg.bat invocation</strong></code></div>
<div class="content">
<pre>fsreg.bat passthrough build\Debug\passthrough-x64.exe "-u %1 -m %2" "D:P(A;;RPWPLC;;;WD)"</pre>
</div>
</div>
<div class="paragraph">
<p>With this step complete we can now launch our file system from any command prompt.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="NetUse.png" alt="First Run">
</div>
</div>
<div class="paragraph">
<p>Alternatively one can use the Windows explorer.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="Explorer.png" alt="First Run">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In less than 1000 lines of C code we have written a Windows file system. Our file system implements all commonly used file functionality on Windows. It integrates fully with the OS and has been tested to give us reasonable confidence that it works as expected under many scenarios.</p>
</div>
<div class="paragraph">
<p>Time to go on and create your own file system! Some ideas for quick gratification:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>RegFs</strong>: Create a file system view of the registry. Bonus points if you make it read/write and if you find creative ways of handling different registry value types.</p>
</li>
<li>
<p><strong>WinObjFs</strong>: Are you familiar with WinObj from SysInternals? It&#8217;s a fantastic app to explore the NTOS object namespace. Create a file system that presents this namespace as a file system. <strong>Make it read-only!</strong></p>
</li>
<li>
<p><strong>ProcFs</strong>: Create something akin to procfs for Windows.</p>
</li>
</ul>
</div>
</div>
</div>

</div>
      </div>

    </div>
  </body>
</html>
